<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gesti√≥n de Escrituras</title>
<link href="https://fonts.googleapis.com/css2?family=Source+Sans+3:wght@400;500;600;700&family=Instrument+Serif&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#f5f3ef;--bg2:#eae7e1;--white:#fff;--card:#fff;--border:#d9d5cd;--border-l:#e8e5de;
  --text:#2c2a25;--dim:#7a7670;--light:#a09a92;
  --accent:#2563eb;--accent-l:#dbeafe;--accent-d:#1d4ed8;
  --green:#16a34a;--green-l:#dcfce7;--amber:#d97706;--amber-l:#fef3c7;
  --red:#dc2626;--red-l:#fee2e2;--purple:#7c3aed;--purple-l:#ede9fe;
  --teal:#0d9488;--teal-l:#ccfbf1;
  --radius:10px;--shadow:0 1px 3px rgba(0,0,0,.06);
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Source Sans 3',sans-serif;background:var(--bg);color:var(--text);min-height:100vh}

.header{background:var(--white);border-bottom:1px solid var(--border);padding:12px 20px;position:sticky;top:0;z-index:100}
.header-inner{max-width:1440px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px}
.logo{display:flex;align-items:center;gap:10px}
.logo-mark{width:38px;height:38px;border-radius:8px;background:linear-gradient(135deg,var(--accent),#6366f1);display:flex;align-items:center;justify-content:center;color:#fff;font-size:18px;font-weight:700}
.logo h1{font-family:'Instrument Serif',serif;font-size:22px;font-weight:400}
.logo-sub{font-size:11px;color:var(--dim);letter-spacing:1.5px;text-transform:uppercase}
.header-right{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.conn-badge{display:flex;align-items:center;gap:5px;padding:5px 12px;border-radius:20px;font-size:12px;font-weight:600}
.conn-ok{background:var(--green-l);color:var(--green)}.conn-no{background:var(--red-l);color:var(--red)}
.conn-dot{width:6px;height:6px;border-radius:50%}
.conn-ok .conn-dot{background:var(--green);animation:blink 2s infinite}.conn-no .conn-dot{background:var(--red)}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}

.btn{padding:8px 16px;border-radius:7px;border:none;font-family:inherit;font-size:13px;font-weight:600;cursor:pointer;transition:all .15s;display:inline-flex;align-items:center;gap:5px}
.btn:active{transform:scale(.97)}
.btn-primary{background:var(--accent);color:#fff}.btn-primary:hover{background:var(--accent-d)}
.btn-ghost{background:transparent;color:var(--dim);border:1px solid var(--border)}.btn-ghost:hover{background:var(--bg);color:var(--text)}
.btn-green{background:var(--green);color:#fff}.btn-green:hover{background:#15803d}
.btn-red{background:var(--red-l);color:var(--red)}.btn-red:hover{background:#fecaca}
.btn-sm{padding:5px 11px;font-size:12px}
.btn-amber{background:var(--amber);color:#fff}.btn-amber:hover{background:#b45309}

.tabs-bar{max-width:1440px;margin:0 auto;padding:16px 20px 0;display:flex;gap:2px;overflow-x:auto}
.tab-btn{padding:10px 18px;border:none;background:transparent;font-family:inherit;font-size:13px;font-weight:600;color:var(--dim);cursor:pointer;border-radius:8px 8px 0 0;transition:all .15s;white-space:nowrap}
.tab-btn:hover{color:var(--text);background:var(--white)}
.tab-btn.active{color:var(--accent);background:var(--white);box-shadow:inset 0 2px 0 var(--accent)}

.main{max-width:1440px;margin:0 auto;padding:0 20px 60px}
.panel{display:none}.panel.active{display:block}
.card{background:var(--card);border:1px solid var(--border-l);border-radius:var(--radius);box-shadow:var(--shadow)}

.stats-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(155px,1fr));gap:10px;padding:16px 0}
.stat-box{background:var(--white);border:1px solid var(--border-l);border-radius:var(--radius);padding:14px 16px}
.stat-box .label{font-size:11px;color:var(--dim);text-transform:uppercase;letter-spacing:.8px}
.stat-box .num{font-size:26px;font-weight:700;margin-top:2px}
.n-blue{color:var(--accent)}.n-green{color:var(--green)}.n-amber{color:var(--amber)}.n-red{color:var(--red)}.n-purple{color:var(--purple)}.n-teal{color:var(--teal)}

.alert-card{display:flex;align-items:flex-start;gap:10px;padding:10px 14px;border-radius:8px;margin-bottom:5px;font-size:13px;line-height:1.5}
.a-red{background:var(--red-l);color:var(--red);border-left:3px solid var(--red)}
.a-amber{background:var(--amber-l);color:var(--amber);border-left:3px solid var(--amber)}

.toolbar{display:flex;gap:8px;padding:14px 0;flex-wrap:wrap;align-items:center}
.search-input{flex:1;min-width:220px;padding:9px 14px 9px 36px;background:var(--white);border:1px solid var(--border);border-radius:7px;font-family:inherit;font-size:14px;color:var(--text);background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='15' height='15' fill='%23a09a92' viewBox='0 0 16 16'%3E%3Cpath d='M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:12px center}
.search-input:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-l)}
select.flt{padding:9px 12px;background:var(--white);border:1px solid var(--border);border-radius:7px;font-family:inherit;font-size:13px;color:var(--text);cursor:pointer}

.table-card{overflow:hidden;overflow-x:auto}
table{width:100%;border-collapse:collapse;font-size:13px}
thead th{text-align:left;padding:10px 12px;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--dim);background:var(--bg);border-bottom:1px solid var(--border);white-space:nowrap;position:sticky;top:0}
td{padding:9px 12px;border-bottom:1px solid var(--border-l);white-space:nowrap;vertical-align:middle}
tr.rw{cursor:pointer}tr.rw:hover td{background:var(--accent-l)}

.badge{display:inline-block;padding:2px 9px;border-radius:12px;font-size:11px;font-weight:700;white-space:nowrap}
.b-blue{background:var(--accent-l);color:var(--accent)}.b-green{background:var(--green-l);color:var(--green)}
.b-amber{background:var(--amber-l);color:var(--amber)}.b-red{background:var(--red-l);color:var(--red)}
.b-purple{background:var(--purple-l);color:var(--purple)}.b-teal{background:var(--teal-l);color:var(--teal)}
.b-gray{background:var(--bg2);color:var(--dim)}

.vto-tag{font-size:11px;font-weight:600;padding:2px 7px;border-radius:4px}
.vto-exp{background:var(--red);color:#fff}.vto-urg{background:var(--amber);color:#fff}.vto-ok{background:var(--green-l);color:var(--green)}

.overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.35);backdrop-filter:blur(3px);z-index:200;align-items:flex-start;justify-content:center;padding:30px 16px;overflow-y:auto}
.overlay.open{display:flex}
.modal{background:var(--white);border-radius:14px;width:100%;max-width:800px;box-shadow:0 20px 50px rgba(0,0,0,.15);animation:mUp .2s ease}
@keyframes mUp{from{opacity:0;transform:translateY(12px)}}
.modal-head{display:flex;justify-content:space-between;align-items:center;padding:18px 24px;border-bottom:1px solid var(--border-l)}
.modal-head h2{font-size:17px;font-weight:700}
.modal-x{width:30px;height:30px;border-radius:6px;border:none;background:var(--bg);color:var(--dim);font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center}
.modal-body{padding:20px 24px;max-height:70vh;overflow-y:auto}
.modal-foot{padding:14px 24px;border-top:1px solid var(--border-l);display:flex;justify-content:flex-end;gap:8px}

.fg{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.fi{display:flex;flex-direction:column;gap:3px}.fi.full{grid-column:1/-1}
.fi label{font-size:11px;font-weight:700;color:var(--dim);text-transform:uppercase;letter-spacing:.4px}
.fi input,.fi select,.fi textarea{padding:9px 11px;background:var(--bg);border:1px solid var(--border);border-radius:6px;font-family:inherit;font-size:14px;color:var(--text)}
.fi input:focus,.fi select:focus,.fi textarea:focus{outline:none;border-color:var(--accent);background:var(--white);box-shadow:0 0 0 3px var(--accent-l)}
.fi textarea{resize:vertical;min-height:60px}
.fi input:read-only{background:var(--bg2);color:var(--dim)}
.fi .computed{background:var(--green-l);font-weight:700;color:var(--green)}
.st{grid-column:1/-1;font-size:12px;font-weight:700;color:var(--accent);padding:10px 0 0;border-top:1px solid var(--border-l);margin-top:4px;display:flex;align-items:center;gap:6px}

/* Combo select+input for "OTRO" */
.combo{display:flex;gap:4px}
.combo select{flex:1}.combo input{flex:1;display:none}
.combo.show-other select{flex:0 0 100px}.combo.show-other input{display:block;flex:1}

.detail-wrap{padding:16px 0}
.detail-top{display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:10px;margin-bottom:14px}
.detail-id{font-family:'Instrument Serif',serif;font-size:24px}
.detail-sub{font-size:14px;color:var(--dim);margin-top:2px}
.detail-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:14px;padding:20px;background:var(--bg);border-radius:8px}
.df label{font-size:10px;color:var(--light);text-transform:uppercase;letter-spacing:.5px}
.df .val{font-size:14px;font-weight:600;margin-top:1px}

.obs-panel{margin-top:16px;padding:16px;background:var(--white);border:1px solid var(--border-l);border-radius:8px}
.obs-panel h4{font-size:12px;color:var(--dim);text-transform:uppercase;margin-bottom:8px}
.obs-content{font-size:14px;line-height:1.7;white-space:pre-wrap}
.quick-add{display:flex;gap:8px;margin-top:12px}
.quick-add input{flex:1;padding:9px 12px;background:var(--bg);border:1px solid var(--border);border-radius:6px;font-family:inherit;font-size:14px;color:var(--text)}
.quick-add input:focus{outline:none;border-color:var(--accent)}

/* Pagos list in CLI detail */
.pago-row{display:flex;gap:8px;align-items:center;padding:8px 12px;border-bottom:1px solid var(--border-l);font-size:13px}
.pago-row:last-child{border-bottom:none}
.pago-row .p-concept{flex:1;font-weight:500}
.pago-row .p-amount{font-weight:700;min-width:80px;text-align:right}
.pago-row .p-date{color:var(--dim);min-width:75px}

.recibo-box{background:var(--white);border:2px solid var(--text);border-radius:4px;padding:24px;max-width:500px;margin:16px auto;font-size:13px;line-height:1.8}
.recibo-box .r-header{text-align:center;border-bottom:1px solid var(--border);padding-bottom:10px;margin-bottom:10px}
.recibo-box .r-header strong{font-size:15px}
.recibo-box .r-num{text-align:right;font-weight:700}
.recibo-box .r-total{font-size:18px;font-weight:700;text-align:right;border-top:2px solid var(--text);padding-top:8px;margin-top:8px}

.toast{position:fixed;bottom:20px;right:20px;z-index:999;padding:10px 18px;border-radius:8px;font-size:13px;font-weight:600;transform:translateY(60px);opacity:0;transition:all .3s;box-shadow:0 4px 12px rgba(0,0,0,.08)}
.toast.show{transform:translateY(0);opacity:1}
.t-ok{background:var(--green);color:#fff}.t-err{background:var(--red);color:#fff}.t-info{background:var(--accent);color:#fff}

.empty-msg{text-align:center;padding:50px 20px;color:var(--dim)}

@media(max-width:768px){.fg{grid-template-columns:1fr}.stats-row{grid-template-columns:repeat(2,1fr)}.detail-grid{grid-template-columns:1fr 1fr}.header{padding:10px 14px}.main{padding:0 14px 40px}.cal-day{min-height:50px}}
@media print{body *{visibility:hidden}.recibo-box,.recibo-box *{visibility:visible}.recibo-box{position:absolute;left:0;top:0;border:2px solid #000}}
.cal-head{text-align:center;font-size:11px;font-weight:700;color:var(--dim);padding:6px 0;text-transform:uppercase}
.cal-day{min-height:80px;background:var(--white);border:1px solid var(--border-l);border-radius:4px;padding:4px 6px;font-size:12px;cursor:pointer;transition:background .1s}
.cal-day:hover{background:var(--accent-l)}.cal-day.today{border-color:var(--accent);border-width:2px}.cal-day.other{opacity:.3}
.cal-num{font-weight:700;font-size:13px;margin-bottom:2px}
.cal-ev{font-size:10px;padding:1px 4px;border-radius:3px;margin-bottom:1px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.cal-ev.firma{background:var(--accent-l);color:var(--accent)}.cal-ev.vto{background:var(--red-l);color:var(--red)}.cal-ev.vto-ok{background:var(--amber-l);color:var(--amber)}
.contact-card{padding:12px 16px;background:var(--white);border:1px solid var(--border-l);border-radius:8px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center}
.contact-card .cn{font-weight:700;font-size:14px}.contact-card .ct{font-size:12px;color:var(--dim)}
.contact-card .cd{font-size:13px;margin-top:4px}
.chk-row{display:flex;align-items:center;gap:8px;padding:8px 0;border-bottom:1px solid var(--border-l);font-size:14px}
.chk-row:last-child{border-bottom:none}
.chk-row input[type=checkbox]{width:18px;height:18px;accent-color:var(--green)}
.chk-row.done{text-decoration:line-through;color:var(--dim)}
.imm-row{border:1px solid var(--border-l);border-radius:8px;padding:12px;margin-bottom:8px}
</style>
</head>
<body>

<header class="header">
  <div class="header-inner">
    <div class="logo">
      <div class="logo-mark">GE</div>
      <div><h1>Gesti√≥n de Escrituras</h1><div class="logo-sub">Control &amp; Facturaci√≥n</div></div>
    </div>
    <div class="header-right">
      <div id="connBadge" class="conn-badge conn-no"><div class="conn-dot"></div><span>Sin conectar</span></div>
      <button class="btn btn-primary" onclick="openNewExp()">Ôºã Nuevo Expediente</button>
    </div>
  </div>
</header>

<div class="tabs-bar">
  <button class="tab-btn active" data-tab="resumen">üìä Resumen</button>
  <button class="tab-btn" data-tab="control">üìã Control</button>
  <button class="tab-btn" data-tab="cliente">üí∂ Cliente ‚Ç¨</button>
  <button class="tab-btn" data-tab="calendario">üìÖ Calendario</button>
  <button class="tab-btn" data-tab="facturacion">üí∞ Facturaci√≥n</button>
  <button class="tab-btn" data-tab="contactos">üë• Contactos</button>
  <button class="tab-btn" data-tab="config">‚öôÔ∏è Conectar</button>
</div>

<div class="main">

<!-- ‚ïê‚ïê‚ïê RESUMEN ‚ïê‚ïê‚ïê -->
<div id="p-resumen" class="panel active">
  <div id="notifBanner" style="display:none;margin-top:12px;padding:14px 18px;background:var(--red-l);border:1px solid var(--red);border-radius:8px;cursor:pointer" onclick="goTab('calendario')"></div>
  <div class="stats-row">
    <div class="stat-box"><div class="label">Total</div><div class="num n-blue" id="sT">0</div></div>
    <div class="stat-box"><div class="label">Firmados</div><div class="num n-green" id="sF">0</div></div>
    <div class="stat-box"><div class="label">Pte. Firma</div><div class="num n-amber" id="sP">0</div></div>
    <div class="stat-box"><div class="label">En Registro</div><div class="num n-purple" id="sR">0</div></div>
    <div class="stat-box"><div class="label">Finalizados</div><div class="num n-teal" id="sE">0</div></div>
    <div class="stat-box"><div class="label">‚ö†Ô∏è Alertas</div><div class="num n-red" id="sA">0</div></div>
    <div class="stat-box"><div class="label">Cobrado este mes</div><div class="num n-green" id="sCob">0</div></div>
    <div class="stat-box"><div class="label">Te deben clientes</div><div class="num n-red" id="sDeb">0</div></div>
  </div>
  <div id="alertsBox"></div>
  <div class="card table-card" style="margin-top:8px">
    <table><thead><tr><th>N¬∫ Exp.</th><th>Gesti√≥n</th><th>Cliente</th><th>Estado</th><th>Alertas</th><th>Observaciones</th></tr></thead>
    <tbody id="tRes"></tbody></table>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê CONTROL ‚ïê‚ïê‚ïê -->
<div id="p-control" class="panel">
  <div class="toolbar">
    <input class="search-input" id="sCtrl" placeholder="Buscar expediente, cliente, n¬∫...">
    <select class="flt" id="fEst"><option value="">Todo estado</option><option value="pte_firma">Pte. Firma</option><option value="firmado">Firmado</option><option value="retirado">Retirado Notar√≠a</option><option value="impuestos">Impuestos</option><option value="en_registro">En Registro</option><option value="recogido">Recogido</option><option value="entregado">Entregado</option><option value="finalizado">Finalizado</option></select>
    <select class="flt" id="fTip"><option value="">Todos tipos</option><option>COMPRAVENTA</option><option>HERENCIA</option><option>CANCELACION</option><option>DONACION</option><option>PODER</option><option>OBRA NUEVA</option><option>EXCESO</option><option>TESTAMENTO</option></select>
    <button class="btn btn-ghost btn-sm" onclick="exportCSV('control')">üì• Excel</button>
  </div>
  <div id="ctrlList"><div class="card table-card">
    <table><thead><tr>
      <th>N¬∫ Exp.</th><th>Gesti√≥n</th><th>Cliente</th><th>Notario/a</th><th>Firma</th><th>Protocolo</th>
      <th>Fac. Notar√≠a</th><th>Pago Not.</th><th>Retirada</th><th>Plusval√≠a</th><th>Impuestos</th>
      <th>Registro</th><th>Ent. Reg.</th><th>Provisi√≥n</th><th>Listo Rec.</th><th>Fra. Reg.</th><th>Recogido</th><th>Entregado</th><th>Alertas</th>
    </tr></thead><tbody id="tCtrl"></tbody></table>
  </div></div>
  <div id="ctrlDet" style="display:none"></div>
</div>

<!-- ‚ïê‚ïê‚ïê CLIENTE ‚Ç¨ ‚ïê‚ïê‚ïê -->
<div id="p-cliente" class="panel">
  <div class="toolbar">
    <input class="search-input" id="sCli" placeholder="Buscar cliente, expediente...">
    <select class="flt" id="fPag"><option value="">Todos</option><option value="pend">Pago pendiente</option><option value="ok">Pagado / Finalizado</option></select>
    <button class="btn btn-ghost btn-sm" onclick="exportCSV('cliente')">üì• Excel</button>
  </div>
  <div id="cliList"><div class="card table-card">
    <table><thead><tr><th>N¬∫ Exp.</th><th>Cliente</th><th>Gesti√≥n</th><th>Total Exp.</th><th>Total Pagado</th><th>Pendiente</th><th>Estado</th></tr></thead>
    <tbody id="tCli"></tbody></table>
  </div></div>
  <div id="cliDet" style="display:none"></div>
</div>

<!-- ‚ïê‚ïê‚ïê CALENDARIO ‚ïê‚ïê‚ïê -->
<div id="p-calendario" class="panel">
  <div style="display:flex;align-items:center;gap:12px;padding:12px 0">
    <button class="btn btn-ghost btn-sm" onclick="calMove(-1)">‚óÄ</button>
    <h3 id="calTitle" style="font-size:16px;min-width:180px;text-align:center"></h3>
    <button class="btn btn-ghost btn-sm" onclick="calMove(1)">‚ñ∂</button>
    <button class="btn btn-ghost btn-sm" onclick="calToday()">Hoy</button>
  </div>
  <div id="calGrid" style="display:grid;grid-template-columns:repeat(7,1fr);gap:2px"></div>
</div>

<!-- ‚ïê‚ïê‚ïê FACTURACI√ìN ‚ïê‚ïê‚ïê -->
<div id="p-facturacion" class="panel">
  <div class="toolbar">
    <select class="flt" id="fFacMes"></select>
    <button class="btn btn-ghost btn-sm" onclick="exportCSV('facturacion')">üì• Excel</button>
  </div>
  <div class="stats-row" id="facStats"></div>
  <h4 style="font-size:13px;margin:12px 0 8px">Deudas a terceros (Notar√≠a / Registro / T√©cnicos)</h4>
  <div class="card table-card"><table><thead><tr><th>N¬∫ Exp.</th><th>Cliente</th><th>Concepto</th><th>Factura</th><th>Pagado</th><th>Pendiente</th></tr></thead>
  <tbody id="tDeudas"></tbody></table></div>
  <h4 style="font-size:13px;margin:16px 0 8px">Deudas de clientes</h4>
  <div class="card table-card"><table><thead><tr><th>N¬∫ Exp.</th><th>Cliente</th><th>Total Exp.</th><th>Pagado</th><th>Pendiente</th></tr></thead>
  <tbody id="tCliDeudas"></tbody></table></div>
</div>

<!-- ‚ïê‚ïê‚ïê CONTACTOS ‚ïê‚ïê‚ïê -->
<div id="p-contactos" class="panel">
  <div class="toolbar">
    <input class="search-input" id="sCont" placeholder="Buscar contacto...">
    <select class="flt" id="fContTipo"><option value="">Todos</option><option>Notario</option><option>Registro</option><option>T√©cnico</option><option>Cliente</option><option>Otro</option></select>
    <button class="btn btn-primary btn-sm" onclick="openNewContact()">Ôºã Contacto</button>
  </div>
  <div id="contList"></div>
</div>

<!-- ‚ïê‚ïê‚ïê CONFIG ‚ïê‚ïê‚ïê -->
<div id="p-config" class="panel">
  <div class="card" style="padding:24px;margin:20px 0">
    <h3 style="font-size:17px;margin-bottom:16px">üîó Conectar con Google Sheets</h3>
    <p style="color:var(--dim);font-size:13px;line-height:1.7;margin-bottom:20px">Solo tienes que hacerlo una vez. Tus datos se guardan localmente aunque no conectes.</p>
    <div id="configSteps"></div>
    <div style="margin-top:16px">
      <label style="font-size:11px;font-weight:700;color:var(--dim);text-transform:uppercase">URL de tu Web App</label>
      <input type="text" id="sheetUrl" placeholder="https://script.google.com/macros/s/.../exec" style="width:100%;margin-top:4px;padding:10px 12px;background:var(--bg);border:1px solid var(--border);border-radius:6px;font-family:inherit;font-size:13px;color:var(--text)">
      <div style="margin-top:8px;display:flex;gap:8px">
        <button class="btn btn-green" onclick="doConnect()">‚úÖ Conectar</button>
        <button class="btn btn-ghost" onclick="doTest()">üîÑ Probar</button>
      </div>
    </div>
    <div style="margin-top:16px;padding:12px;background:var(--amber-l);border-radius:8px;font-size:13px;color:var(--amber);line-height:1.5">
      <strong>üí°</strong> La app funciona sin Google Sheets guardando en tu navegador. Sheets es el respaldo en la nube. Las instrucciones para configurarlo son las mismas que en la versi√≥n anterior.
    </div>
  </div>
</div>

</div>

<!-- ‚ïê‚ïê‚ïê MODAL EXPEDIENTE ‚ïê‚ïê‚ïê -->
<div class="overlay" id="ovExp">
<div class="modal">
  <div class="modal-head"><h2 id="mExpTit">Nuevo Expediente</h2><button class="modal-x" onclick="closeOv('ovExp')">‚úï</button></div>
  <div class="modal-body">
    <div class="fg">
      <div class="st">üìã Datos del expediente</div>
      <div class="fi"><label>N¬∫ Expediente *</label><input id="e_numExp" placeholder="GE26/1"></div>
      <div class="fi"><label>Gesti√≥n *</label>
        <div class="combo" id="combo_gestion">
          <select onchange="toggleCombo(this)"><option value="">Selecciona...</option>
            <option>COMPRAVENTA</option><option>ACEPTACION Y ADJ HERENCIA</option><option>CANCELACION HIPOTECA</option>
            <option>DONACION</option><option>PODER</option><option>DECLARACION OBRA NUEVA</option>
            <option>EXCESO CABIDA</option><option>DIVORCIO</option><option>CAPITULACIONES</option>
            <option>TESTAMENTO</option><option>ACTA DE NOTORIEDAD</option><option>RENUNCIA</option>
            <option value="__otro">OTRO (escribir)</option>
          </select><input placeholder="Escribe el tipo..." id="e_gestion_otro">
        </div>
      </div>
      <div class="fi"><label>Cliente *</label><input id="e_cliente"></div>
      <div class="fi"><label>DNI / NIE</label><input id="e_dni"></div>
      <div class="fi full"><label>Otros clientes / intervinientes</label><input id="e_otros"></div>

      <div class="st">üìÑ Informe t√©cnico</div>
      <div class="fi"><label>Informe t√©cnico</label><input id="e_informe"></div>
      <div class="fi"><label>Importe factura informe (‚Ç¨)</label><input type="number" step="0.01" id="e_impInforme" placeholder="0,00 ‚Ç¨"></div>
      <div class="fi"><label>Fecha pago informe</label><input type="date" id="e_fPagoInforme"></div>

      <div class="st">üèõÔ∏è Notar√≠a</div>
      <div class="fi"><label>Notario/a</label>
        <div class="combo" id="combo_notario">
          <select onchange="toggleCombo(this)"><option value="">‚Äî</option>
            <option>MA ELENA APARICIO RIZZO</option><option>CRISTINA MARIA PILAR MI√ëARRO MARZAL</option>
            <option value="__otro">OTRO (escribir)</option>
          </select><input placeholder="Nombre notario..." id="e_notario_otro">
        </div>
      </div>
      <div class="fi"><label>Fecha y hora prevista firma</label><input type="datetime-local" id="e_fhPrevista"></div>
      <div class="fi"><label>Fecha firma</label><input type="date" id="e_fechaFirma"></div>
      <div class="fi"><label>Protocolo</label><input id="e_protocolo"></div>
      <div class="fi"><label>Importe factura notar√≠a (‚Ç¨)</label><input type="number" step="0.01" id="e_impNotaria"></div>
      <div class="fi"><label>Pago 1 notar√≠a (‚Ç¨)</label><input type="number" step="0.01" id="e_pago1"></div>
      <div class="fi"><label>Fecha pago 1</label><input type="date" id="e_fPago1"></div>
      <div class="fi"><label>Pago 2 notar√≠a (‚Ç¨)</label><input type="number" step="0.01" id="e_pago2"></div>
      <div class="fi"><label>Fecha pago 2</label><input type="date" id="e_fPago2"></div>
      <div class="fi"><label>Fecha retirada notar√≠a</label><input type="date" id="e_fRetirada"></div>

      <div class="st">üí∞ Plusval√≠a</div>
      <div class="fi"><label>Plusval√≠a</label>
        <select id="e_plusvalia" onchange="togglePlusvalia()">
          <option value="">‚Äî</option><option value="EX">EXENTO</option>
          <option value="SI">S√ç (pendiente presentar)</option>
          <option value="PRESENTADA">PRESENTADA</option>
        </select>
      </div>
      <div class="fi" id="fi_fPlusvalia" style="display:none"><label>Fecha presentaci√≥n plusval√≠a</label><input type="date" id="e_fPlusvalia"></div>
      <div class="fi" id="fi_vtoPlusvalia" style="display:none"><label>Vto. plusval√≠a (auto: 1 mes desde firma)</label><input type="date" id="e_vtoPlusvalia" readonly class="computed"></div>

      <div class="st">üí∞ Impuestos</div>
      <div class="fi"><label>Fecha fallecimiento (si herencia)</label><input type="date" id="e_fFallecimiento"></div>
      <div class="fi"><label>Mod. 600 (ITP/AJD)</label>
        <select id="e_mod600" onchange="toggleImp('600')"><option value="">‚Äî</option><option value="EX">EXENTO</option><option value="SI">S√ç (pendiente)</option><option value="PRESENTADO">PRESENTADO</option></select>
      </div>
      <div class="fi" id="fi_f600" style="display:none"><label>Fecha presentaci√≥n Mod. 600</label><input type="date" id="e_f600"></div>
      <div class="fi" id="fi_vto600" style="display:none"><label>Vto. Mod. 600 (auto: 2 meses firma)</label><input type="date" id="e_vto600" readonly class="computed"></div>
      <div class="fi"><label>Mod. 650 (ISD)</label>
        <select id="e_mod650" onchange="toggleImp('650')"><option value="">‚Äî</option><option value="EX">EXENTO</option><option value="SI">S√ç (pendiente)</option><option value="PRESENTADO">PRESENTADO</option></select>
      </div>
      <div class="fi" id="fi_f650" style="display:none"><label>Fecha presentaci√≥n Mod. 650</label><input type="date" id="e_f650"></div>
      <div class="fi" id="fi_vto650" style="display:none"><label>Vto. Mod. 650 (auto: 6 meses fallec.)</label><input type="date" id="e_vto650" readonly class="computed"></div>
      <div class="fi"><label>Mod. 660</label>
        <select id="e_mod660" onchange="toggleImp('660')"><option value="">‚Äî</option><option value="EX">EXENTO</option><option value="SI">S√ç (pendiente)</option><option value="PRESENTADO">PRESENTADO</option></select>
      </div>
      <div class="fi" id="fi_f660" style="display:none"><label>Fecha presentaci√≥n Mod. 660</label><input type="date" id="e_f660"></div>
      <div class="fi" id="fi_vto660" style="display:none"><label>Vto. Mod. 660 (auto: 6 meses fallec.)</label><input type="date" id="e_vto660" readonly class="computed"></div>

      <div class="st">üìù Registro</div>
      <div class="fi"><label>Registro</label>
        <div class="combo" id="combo_registro">
          <select onchange="toggleCombo(this)"><option value="">‚Äî</option>
            <option>PROPIEDAD DE PURCHENA</option><option>MERCANTIL ALMERIA</option>
            <option value="__otro">OTRO (escribir)</option>
          </select><input placeholder="Nombre registro..." id="e_registro_otro">
        </div>
      </div>
      <div class="fi"><label>Entregado registro (fecha)</label><input type="date" id="e_fEntregaReg"></div>
      <div class="fi"><label>Provisi√≥n entregada (‚Ç¨)</label><input type="number" step="0.01" id="e_provision"></div>
      <div class="fi"><label>Lista para recoger</label><input type="date" id="e_fListaRecoger"></div>
      <div class="fi"><label>Total factura registro (‚Ç¨)</label><input type="number" step="0.01" id="e_totalFraReg"></div>
      <div class="fi"><label>Fecha pago fra. registro</label><input type="date" id="e_fPagoFraReg"></div>
      <div class="fi"><label>Fecha recogida registro</label><input type="date" id="e_fRecogida"></div>
      <div class="fi"><label>Entregado al cliente</label><input type="date" id="e_fEntregaCli"></div>

      <div class="st">üè† Inmuebles</div>
      <div id="inmueblesContainer" style="grid-column:1/-1"></div>
      <div style="grid-column:1/-1"><button class="btn btn-ghost btn-sm" onclick="addInmueble()" type="button">Ôºã A√±adir inmueble</button></div>

      <div class="st">üìå Estado y notas</div>
      <div class="fi"><label>Estado</label><select id="e_estado">
        <option value="pte_firma">Pendiente firma</option><option value="firmado">Firmado / En Notar√≠a</option>
        <option value="retirado">Retirado de Notar√≠a</option><option value="impuestos">Liquidando impuestos</option>
        <option value="en_registro">En Registro</option><option value="recogido">Recogido de Registro</option>
        <option value="entregado">Entregado al Cliente</option><option value="finalizado">Finalizado</option>
      </select></div>
      <div class="fi"><label>Fecha vto. actuaci√≥n (aviso manual)</label><input type="date" id="e_fVto"></div>
      <div class="fi full"><label>Observaciones</label><textarea id="e_obs" rows="3"></textarea></div>
    </div>
  </div>
  <div class="modal-foot"><button class="btn btn-ghost" onclick="closeOv('ovExp')">Cancelar</button><button class="btn btn-green" onclick="saveExp()">üíæ Guardar</button></div>
</div></div>

<!-- ‚ïê‚ïê‚ïê MODAL CLIENTE ‚Ç¨ ‚ïê‚ïê‚ïê -->
<div class="overlay" id="ovCli">
<div class="modal">
  <div class="modal-head"><h2 id="mCliTit">Presupuesto Cliente</h2><button class="modal-x" onclick="closeOv('ovCli')">‚úï</button></div>
  <div class="modal-body">
    <div class="fg">
      <div class="st">üìã Datos</div>
      <div class="fi"><label>N¬∫ Expediente</label><input id="c_numExp" readonly></div>
      <div class="fi"><label>Cliente</label><input id="c_cliente" readonly></div>
      <div class="fi full"><label>Gesti√≥n</label><input id="c_gestion" readonly></div>

      <div class="st">üí∂ Desglose presupuesto (conceptos editables)</div>
      <div class="fi"><label>Factura informe t√©cnico (‚Ç¨)</label><input type="number" step="0.01" id="c_fraInfTec" onchange="calcTotal()"></div>
      <div class="fi"><label>Asesoramiento (‚Ç¨)</label><input type="number" step="0.01" id="c_asesoramiento" onchange="calcTotal()"></div>
      <div class="fi"><label>Minuta e intervenci√≥n notar√≠a (‚Ç¨)</label><input type="number" step="0.01" id="c_minuta" onchange="calcTotal()"></div>
      <div class="fi"><label>Factura notar√≠a (‚Ç¨)</label><input type="number" step="0.01" id="c_fraNotaria" onchange="calcTotal()"></div>
      <div class="fi"><label>Presentaci√≥n plusval√≠a (‚Ç¨)</label><input type="number" step="0.01" id="c_presPlusvalia" onchange="calcTotal()"></div>
      <div class="fi"><label>Valor a declarar (‚Ç¨)</label><input type="number" step="0.01" id="c_valorDeclarar" onchange="calcITP()"></div>
      <div class="fi"><label>% ITP</label><input type="number" step="0.01" id="c_pctITP" onchange="calcITP()"></div>
      <div class="fi"><label>Liquidaci√≥n ITP (‚Ç¨) = Valor √ó %</label><input type="number" step="0.01" id="c_liqITP" readonly class="computed"></div>
      <div class="fi"><label>Mod. 600 (‚Ç¨)</label><input type="number" step="0.01" id="c_mod600" onchange="calcTotal()"></div>
      <div class="fi"><label>Mod. 660 (‚Ç¨)</label><input type="number" step="0.01" id="c_mod660" onchange="calcTotal()"></div>
      <div class="fi"><label>Mod. 650 ‚Äî Precio unitario (‚Ç¨)</label><input type="number" step="0.01" id="c_mod650unit" onchange="calcMod650()"></div>
      <div class="fi"><label>Mod. 650 ‚Äî Cantidad</label><input type="number" step="1" id="c_mod650qty" onchange="calcMod650()" value="1"></div>
      <div class="fi"><label>Mod. 650 ‚Äî Total (‚Ç¨)</label><input type="number" step="0.01" id="c_mod650total" readonly class="computed"></div>
      <div class="fi"><label>Present. y liquid. impuesto (‚Ç¨)</label><input type="number" step="0.01" id="c_presLiqImp" onchange="calcTotal()"></div>
      <div class="fi"><label>Present. y recogida registro (‚Ç¨)</label><input type="number" step="0.01" id="c_presRecReg" onchange="calcTotal()"></div>
      <div class="fi"><label>Provisi√≥n registro (‚Ç¨)</label><input type="number" step="0.01" id="c_provReg" onchange="calcTotal()"></div>
      <div class="fi"><label>Fra. Registro (‚Ç¨) ‚Äî viene de Control</label><input type="number" step="0.01" id="c_fraReg" readonly class="computed"></div>
      <div class="fi"><label>Honorarios (‚Ç¨)</label><input type="number" step="0.01" id="c_honorarios" onchange="calcTotal()"></div>
      <div class="fi"><label>IVA (‚Ç¨)</label><input type="number" step="0.01" id="c_iva" onchange="calcTotal()"></div>
      <div class="fi full"><label>Otros servicios (‚Ç¨)</label><input type="number" step="0.01" id="c_otrosServ" onchange="calcTotal()"></div>

      <div class="st">üìä Totales</div>
      <div class="fi"><label>TOTAL EXPEDIENTE (‚Ç¨) (sin Fra. Registro)</label><input type="number" step="0.01" id="c_totalExp" readonly class="computed" style="font-size:16px"></div>
      <div class="fi"><label>Diferencia Provisi√≥n Reg. vs Fra. Reg.</label><input id="c_diffReg" readonly class="computed"></div>

      <div class="st">üí≥ Pagos del cliente</div>
      <div id="pagosContainer"></div>
      <div style="grid-column:1/-1;margin-top:8px">
        <button class="btn btn-ghost btn-sm" onclick="addPagoRow()">Ôºã A√±adir pago</button>
      </div>

      <div class="st">Estado</div>
      <div class="fi"><label>Estado</label><select id="c_finalizado"><option value="">En curso</option><option value="FINALIZADO">FINALIZADO</option></select></div>
    </div>
  </div>
  <div class="modal-foot">
    <button class="btn btn-amber" onclick="downloadPresupuestoWord()">üìÑ Descargar Word</button>
    <button class="btn btn-ghost" onclick="closeOv('ovCli')">Cancelar</button>
    <button class="btn btn-green" onclick="saveCli()">üíæ Guardar</button>
  </div>
</div></div>

<!-- ‚ïê‚ïê‚ïê MODAL RECIBO ‚ïê‚ïê‚ïê -->
<div class="overlay" id="ovRecibo">
<div class="modal" style="max-width:560px">
  <div class="modal-head"><h2>üßæ Recib√≠</h2><button class="modal-x" onclick="closeOv('ovRecibo')">‚úï</button></div>
  <div class="modal-body">
    <div class="fg">
      <div class="fi"><label>N¬∫ Recibo</label><input id="r_num"></div>
      <div class="fi"><label>Fecha</label><input type="date" id="r_fecha"></div>
      <div class="fi full"><label>Cliente</label><input id="r_cliente"></div>
      <div class="fi full"><label>Concepto</label><textarea id="r_concepto" rows="2"></textarea></div>
      <div class="fi"><label>Importe (‚Ç¨)</label><input type="number" step="0.01" id="r_importe"></div>
    </div>
    <div style="margin-top:12px;text-align:center"><button class="btn btn-primary" onclick="genRecibo()">üëÅÔ∏è Ver recib√≠</button></div>
    <div id="reciboPreview"></div>
  </div>
  <div class="modal-foot"><button class="btn btn-ghost" onclick="closeOv('ovRecibo')">Cerrar</button><button class="btn btn-green" onclick="printRecibo()">üñ®Ô∏è Imprimir</button></div>
</div></div>

<div class="toast" id="toast"></div>

<!-- ‚ïê‚ïê‚ïê MODAL CONTACTO ‚ïê‚ïê‚ïê -->
<div class="overlay" id="ovCont"><div class="modal" style="max-width:500px">
  <div class="modal-head"><h2 id="mContTit">Nuevo Contacto</h2><button class="modal-x" onclick="closeOv('ovCont')">‚úï</button></div>
  <div class="modal-body"><div class="fg">
    <div class="fi"><label>Nombre *</label><input id="ct_nombre"></div>
    <div class="fi"><label>Tipo</label><select id="ct_tipo"><option>Notario</option><option>Registro</option><option>T√©cnico</option><option>Cliente</option><option>Otro</option></select></div>
    <div class="fi"><label>Tel√©fono</label><input id="ct_tel" type="tel"></div>
    <div class="fi"><label>Email</label><input id="ct_email" type="email"></div>
    <div class="fi full"><label>Direcci√≥n</label><input id="ct_dir"></div>
    <div class="fi full"><label>Notas</label><textarea id="ct_notas" rows="2"></textarea></div>
  </div></div>
  <div class="modal-foot"><button class="btn btn-ghost" onclick="closeOv('ovCont')">Cancelar</button><button class="btn btn-green" onclick="saveCont()">üíæ Guardar</button></div>
</div></div>

<!-- ‚ïê‚ïê‚ïê MODAL CHECKLIST ‚ïê‚ïê‚ïê -->
<div class="overlay" id="ovChk"><div class="modal" style="max-width:550px">
  <div class="modal-head"><h2 id="mChkTit">üìã Checklist Documental</h2><button class="modal-x" onclick="closeOv('ovChk')">‚úï</button></div>
  <div class="modal-body"><div id="chkBody"></div></div>
  <div class="modal-foot"><button class="btn btn-green" onclick="saveChk()">üíæ Guardar</button></div>
</div></div>

<!-- ‚ïê‚ïê‚ïê MODAL PLANTILLA NOTAR√çA ‚ïê‚ïê‚ïê -->
<div class="overlay" id="ovPlant"><div class="modal" style="max-width:600px">
  <div class="modal-head"><h2>üìÑ Datos para Notar√≠a</h2><button class="modal-x" onclick="closeOv('ovPlant')">‚úï</button></div>
  <div class="modal-body"><div id="plantBody" style="font-size:14px;line-height:1.8"></div></div>
  <div class="modal-foot"><button class="btn btn-primary" onclick="copyPlant()">üìã Copiar al portapapeles</button><button class="btn btn-ghost" onclick="closeOv('ovPlant')">Cerrar</button></div>
</div></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê STATE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let exps=[],clis=[],contacts=[],curExp=null,curCli=null,editMode=null,editContIdx=null,SURL='';
let calMonth=new Date().getMonth(),calYear=new Date().getFullYear();

// Checklist templates
const CHECKLISTS={
  'HERENCIA':['Certificado de defunci√≥n','Certificado √∫ltimas voluntades','Testamento / Declaraci√≥n herederos','DNI / NIE fallecido','DNI / NIE herederos','Libro de familia','Escrituras inmuebles','Notas simples registrales','Certificados catastrales','Certificado bancario saldos','Certificado seguro vida','Valoraci√≥n inmuebles','Modelo 650','Modelo 660','Plusval√≠a municipal'],
  'COMPRAVENTA':['DNI / NIE comprador','DNI / NIE vendedor','Escritura propiedad','Nota simple actualizada','Certificado catastral','√öltimo recibo IBI','Certificado comunidad (deudas)','Certificado eficiencia energ√©tica','Contrato arras / se√±al','Cheque / transferencia precio'],
  'CANCELACION':['DNI / NIE titular','Escritura de hipoteca','Certificado saldo cero banco','Carta de pago','Nota simple registral'],
  'DONACION':['DNI / NIE donante','DNI / NIE donatario','Escritura propiedad','Nota simple registral','Certificado catastral','Valoraci√≥n del bien'],
  'PODER':['DNI / NIE poderdante','DNI / NIE apoderado','Datos del poder (facultades)'],
  'OBRA NUEVA':['DNI / NIE propietario','Escritura terreno','Licencia de obras','Certificado fin de obra','Certificado catastral','Seguro decenal','Libro del edificio'],
  'EXCESO':['DNI / NIE titular','Escritura propiedad','Nota simple registral','Certificado catastral','Certificaci√≥n t√©cnica'],
  'DEFAULT':['DNI / NIE intervinientes','Escrituras previas','Nota simple registral','Certificado catastral','Documentaci√≥n espec√≠fica']
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê INIT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.addEventListener('DOMContentLoaded',()=>{
  SURL=localStorage.getItem('surl')||'';
  document.getElementById('sheetUrl').value=SURL;
  updateConn();
  exps=JSON.parse(localStorage.getItem('exps')||'[]');
  clis=JSON.parse(localStorage.getItem('clis')||'[]');
  contacts=JSON.parse(localStorage.getItem('contacts')||'[]');
  if(SURL)loadFromSheet();
  renderAll();buildFacMeses();
  document.querySelectorAll('.tab-btn').forEach(t=>t.addEventListener('click',()=>goTab(t.dataset.tab)));
  ['sCtrl','fEst','fTip'].forEach(id=>document.getElementById(id).addEventListener('input',renderCtrl));
  ['sCli','fPag'].forEach(id=>document.getElementById(id).addEventListener('input',renderCli));
  ['sCont','fContTipo'].forEach(id=>document.getElementById(id).addEventListener('input',renderContacts));
  document.getElementById('fFacMes').addEventListener('change',renderFac);
  ['e_fechaFirma','e_fFallecimiento'].forEach(id=>document.getElementById(id).addEventListener('change',calcVtosForm));
  ['e_plusvalia','e_mod600','e_mod650','e_mod660'].forEach(id=>document.getElementById(id).addEventListener('change',calcVtosForm));
});

function goTab(tab){
  document.querySelectorAll('.tab-btn').forEach(x=>x.classList.remove('active'));
  document.querySelectorAll('.panel').forEach(x=>x.classList.remove('active'));
  document.querySelector('[data-tab="'+tab+'"]').classList.add('active');
  document.getElementById('p-'+tab).classList.add('active');
  if(tab==='calendario')renderCal();
  if(tab==='facturacion')renderFac();
  if(tab==='contactos')renderContacts();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê COMBO SELECT+OTRO ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleCombo(sel){
  const combo=sel.closest('.combo');
  if(sel.value==='__otro'){combo.classList.add('show-other');combo.querySelector('input').focus();}
  else{combo.classList.remove('show-other');}
}
function getComboVal(comboId){
  const c=document.getElementById(comboId);
  const sel=c.querySelector('select');
  if(sel.value==='__otro')return c.querySelector('input').value.trim();
  return sel.value;
}
function setComboVal(comboId,val){
  const c=document.getElementById(comboId);
  const sel=c.querySelector('select');
  const opts=[...sel.options].map(o=>o.value);
  if(val && !opts.includes(val)){sel.value='__otro';c.classList.add('show-other');c.querySelector('input').value=val;}
  else{sel.value=val||'';c.classList.remove('show-other');}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PLUSVALIA / IMPUESTOS TOGGLE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function togglePlusvalia(){
  const v=document.getElementById('e_plusvalia').value;
  document.getElementById('fi_fPlusvalia').style.display=v==='PRESENTADA'?'flex':'none';
  document.getElementById('fi_vtoPlusvalia').style.display=v==='SI'?'flex':'none';
  if(v==='SI')calcVtosForm();
}
function toggleImp(mod){
  const v=document.getElementById('e_mod'+mod).value;
  document.getElementById('fi_f'+mod).style.display=v==='PRESENTADO'?'flex':'none';
  document.getElementById('fi_vto'+mod).style.display=v==='SI'?'flex':'none';
  if(v==='SI')calcVtosForm();
}
function calcVtosForm(){
  const firma=document.getElementById('e_fechaFirma').value;
  const fallec=document.getElementById('e_fFallecimiento').value;
  // Plusval√≠a: 1 mes desde firma
  if(document.getElementById('e_plusvalia').value==='SI' && firma){
    const d=new Date(firma);d.setMonth(d.getMonth()+1);
    document.getElementById('e_vtoPlusvalia').value=isoD(d);
  }
  // Mod 600: 2 meses desde firma
  if(document.getElementById('e_mod600').value==='SI' && firma){
    const d=new Date(firma);d.setMonth(d.getMonth()+2);
    document.getElementById('e_vto600').value=isoD(d);
  }
  // Mod 650: 6 meses desde fallecimiento
  if(document.getElementById('e_mod650').value==='SI' && fallec){
    const d=new Date(fallec);d.setMonth(d.getMonth()+6);
    document.getElementById('e_vto650').value=isoD(d);
  }
  // Mod 660: 6 meses desde fallecimiento
  if(document.getElementById('e_mod660').value==='SI' && fallec){
    const d=new Date(fallec);d.setMonth(d.getMonth()+6);
    document.getElementById('e_vto660').value=isoD(d);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê VENCIMIENTOS CALC ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getAlerts(e){
  const a=[];const hoy=new Date();hoy.setHours(0,0,0,0);
  function chk(label,dateStr){
    if(!dateStr)return;
    const d=new Date(dateStr);const diff=Math.ceil((d-hoy)/864e5);
    if(diff<0)a.push({label,dias:diff,tipo:'exp',fecha:d});
    else if(diff<=10)a.push({label,dias:diff,tipo:'urg',fecha:d});
  }
  if(e.plusvalia==='SI')chk('Plusval√≠a',e.vtoPlusvalia);
  if(e.mod600==='SI')chk('Mod. 600',e.vto600);
  if(e.mod650==='SI')chk('Mod. 650',e.vto650);
  if(e.mod660==='SI')chk('Mod. 660',e.vto660);
  if(e.fVto)chk('Vto. manual',e.fVto);
  return a;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê RENDER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderAll(){renderStats();renderRes();renderCtrl();renderCli();showNotif();}

function showNotif(){
  let cnt=0;const items=[];const h=new Date();h.setHours(0,0,0,0);
  exps.forEach(e=>{getAlerts(e).forEach(a=>{if(a.tipo==='exp'||a.dias<=7){cnt++;items.push(e.numExp+' '+a.label);}});});
  const b=document.getElementById('notifBanner');
  if(cnt){b.style.display='block';b.innerHTML='<strong>üö® Tienes '+cnt+' alerta'+(cnt>1?'s':'')+' esta semana:</strong> '+items.slice(0,5).join(' ¬∑ ')+(items.length>5?' y '+(items.length-5)+' m√°s':'')+'<br><span style="font-size:12px">Haz clic para ver el calendario</span>';}
  else b.style.display='none';
}

function renderStats(){
  document.getElementById('sT').textContent=exps.length;
  document.getElementById('sF').textContent=exps.filter(e=>e.fechaFirma).length;
  document.getElementById('sP').textContent=exps.filter(e=>!e.fechaFirma).length;
  document.getElementById('sR').textContent=exps.filter(e=>e.estado==='en_registro').length;
  document.getElementById('sE').textContent=exps.filter(e=>e.estado==='finalizado'||e.estado==='entregado').length;
  let cnt=0;const html=[];
  exps.forEach(e=>{
    getAlerts(e).forEach(a=>{
      cnt++;
      html.push(`<div class="alert-card ${a.tipo==='exp'?'a-red':'a-amber'}"><span>${a.tipo==='exp'?'üö®':'‚ö†Ô∏è'}</span><div><strong>${esc(e.numExp)} ${esc(e.cliente)}</strong> ‚Äî ${a.label} ${a.dias<0?'venci√≥ hace '+Math.abs(a.dias)+' d√≠as':'vence en '+a.dias+' d√≠as'} (${fD(a.fecha)})</div></div>`);
    });
  });
  document.getElementById('sA').textContent=cnt;
  document.getElementById('alertsBox').innerHTML=html.length?'<div style="margin:8px 0"><strong style="font-size:13px">üîî Alertas de vencimientos</strong></div>'+html.join(''):'';
  // Cobrado/Deben
  const now=new Date();const thisM=now.getMonth(),thisY=now.getFullYear();
  let cobrado=0,deben=0;
  clis.forEach(c=>{
    const tp=sumPagos(c);const pend=pf(c.totalExp)-tp;
    if(pend>0.01)deben+=pend;
    (c.pagos||[]).forEach(p=>{if(p.fecha){const d=new Date(p.fecha);if(d.getMonth()===thisM&&d.getFullYear()===thisY)cobrado+=pf(p.importe);}});
  });
  document.getElementById('sCob').textContent=monF(cobrado);
  document.getElementById('sDeb').textContent=monF(deben);
}

function renderRes(){
  const tb=document.getElementById('tRes');
  if(!exps.length){tb.innerHTML='<tr><td colspan="6"><div class="empty-msg">üìÇ Sin expedientes. Crea uno con Ôºã</div></td></tr>';return;}
  tb.innerHTML=exps.slice(0,15).map(e=>{
    const als=getAlerts(e);
    const aH=als.map(a=>`<span class="vto-tag ${a.tipo==='exp'?'vto-exp':'vto-urg'}">${a.label} ${a.dias<0?Math.abs(a.dias)+'d‚ö†':'‚è∞'+a.dias+'d'}</span>`).join(' ')||'‚Äî';
    return `<tr class="rw" onclick="goCtrl('${esc(e.numExp)}')"><td><strong>${esc(e.numExp)}</strong></td><td>${esc(e.gestion)}</td><td>${esc(e.cliente)}</td><td>${estBadge(e.estado)}</td><td>${aH}</td><td style="max-width:200px;overflow:hidden;text-overflow:ellipsis">${esc((e.obs||'').split('\n')[0])}</td></tr>`;
  }).join('');
}

function renderCtrl(){
  const s=document.getElementById('sCtrl').value.toLowerCase();
  const fe=document.getElementById('fEst').value;
  const ft=document.getElementById('fTip').value;
  const f=exps.filter(e=>{
    const ms=!s||[e.numExp,e.cliente,e.gestion,e.otros||''].some(x=>x.toLowerCase().includes(s));
    const me=!fe||e.estado===fe;
    const mt=!ft||(e.gestion||'').toUpperCase().includes(ft);
    return ms&&me&&mt;
  });
  const tb=document.getElementById('tCtrl');
  if(!f.length){tb.innerHTML='<tr><td colspan="19"><div class="empty-msg">Sin resultados</div></td></tr>';return;}
  tb.innerHTML=f.map(e=>{
    const als=getAlerts(e);
    const aH=als.map(a=>`<span class="vto-tag ${a.tipo==='exp'?'vto-exp':'vto-urg'}" title="${a.label}">${a.dias<0?'‚ö†':'‚è∞'}${Math.abs(a.dias)}d</span>`).join(' ')||'';
    return `<tr class="rw" onclick="showCtrl('${esc(e.numExp)}')"><td><strong>${esc(e.numExp)}</strong></td><td style="max-width:160px;overflow:hidden;text-overflow:ellipsis">${esc(e.gestion)}</td><td>${esc(e.cliente)}</td><td style="font-size:11px">${esc(e.notario)}</td><td>${fD(e.fechaFirma)}</td><td>${esc(e.protocolo)}</td><td>${mon(e.impNotaria)}</td><td>${mon(e.pago1)}</td><td>${fD(e.fRetirada)}</td><td>${impBadge(e.plusvalia)}</td><td>${imp600Badge(e)}</td><td style="font-size:11px">${esc(e.registro)}</td><td>${fD(e.fEntregaReg)}</td><td>${mon(e.provision)}</td><td>${fD(e.fListaRecoger)}</td><td>${mon(e.totalFraReg)}</td><td>${fD(e.fRecogida)}</td><td>${fD(e.fEntregaCli)}</td><td>${aH}</td></tr>`;
  }).join('');
}

function renderCli(){
  const s=document.getElementById('sCli').value.toLowerCase();
  const fp=document.getElementById('fPag').value;
  const f=clis.filter(c=>{
    const ms=!s||[c.numExp,c.cliente,c.gestion].some(x=>(x||'').toLowerCase().includes(s));
    const totalPagado=sumPagos(c);const pend=pf(c.totalExp)-totalPagado;
    if(fp==='pend')return ms&&pend>0.01;
    if(fp==='ok')return ms&&(c.finalizado==='FINALIZADO'||pend<=0.01);
    return ms;
  });
  const tb=document.getElementById('tCli');
  if(!f.length){tb.innerHTML='<tr><td colspan="7"><div class="empty-msg">Sin datos</div></td></tr>';return;}
  tb.innerHTML=f.map(c=>{
    const tp=sumPagos(c);const pend=pf(c.totalExp)-tp;
    return `<tr class="rw" onclick="showCli('${esc(c.numExp)}')"><td><strong>${esc(c.numExp)}</strong></td><td>${esc(c.cliente)}</td><td style="max-width:160px;overflow:hidden;text-overflow:ellipsis">${esc(c.gestion)}</td><td><strong>${mon(c.totalExp)}</strong></td><td>${mon(tp)}</td><td style="font-weight:700;${pend>0.01?'color:var(--red)':'color:var(--green)'}">${monF(pend)}</td><td>${c.finalizado==='FINALIZADO'?'<span class="badge b-green">Finalizado</span>':pend>0.01?'<span class="badge b-red">Pendiente</span>':'<span class="badge b-gray">En curso</span>'}</td></tr>`;
  }).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DETAIL CONTROL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showCtrl(id){
  curExp=id;const e=exps.find(x=>x.numExp===id);if(!e)return;
  document.getElementById('ctrlList').style.display='none';
  const det=document.getElementById('ctrlDet');det.style.display='block';

  // Calculate debts
  const facNot=pf(e.impNotaria);const pagNot=pf(e.pago1)+pf(e.pago2);const deudaNot=facNot-pagNot;
  const facInf=pf(e.impInforme);const pagInf=e.fPagoInforme?facInf:0;const deudaInf=facInf-pagInf;
  const facReg=pf(e.totalFraReg);const provReg=pf(e.provision);const deudaReg=facReg-provReg;
  const totalDeuda=Math.max(0,deudaNot)+Math.max(0,deudaInf)+(facReg>0?Math.max(0,deudaReg):(provReg>0?0:0));

  // Build alerts
  const als=getAlerts(e);
  const alertsHtml=als.map(a=>`<div class="alert-card ${a.tipo==='exp'?'a-red':'a-amber'}"><span>${a.tipo==='exp'?'üö®':'‚ö†Ô∏è'}</span><div><strong>${a.label}</strong> ‚Äî ${fD(a.fecha)} (${a.dias<0?Math.abs(a.dias)+' d√≠as atr√°s!':'faltan '+a.dias+' d√≠as'})</div></div>`).join('');

  // Section builder
  function sec(title,fields){
    const rows=fields.filter(f=>f[1]&&f[1]!=='‚Äî'&&f[1]!=='');
    if(!rows.length)return'';
    return`<div style="margin-top:16px"><div style="font-size:12px;font-weight:700;color:var(--accent);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px;padding-bottom:4px;border-bottom:2px solid var(--accent-l)">${title}</div><div class="detail-grid">${rows.map(f=>`<div class="df"><label>${f[0]}</label><div class="val">${f[2]?f[1]:esc(String(f[1]))}</div></div>`).join('')}</div></div>`;
  }

  // Debt summary card
  function debtRow(label,factura,pagado,pendiente){
    if(!factura&&!pagado)return'';
    const color=pendiente>0.01?'var(--red)':pendiente<-0.01?'var(--amber)':'var(--green)';
    const estado=pendiente>0.01?'DEBES '+monF(pendiente):pendiente<-0.01?'A FAVOR '+monF(Math.abs(pendiente)):'PAGADO';
    return`<tr><td>${label}</td><td style="text-align:right">${monF(factura)}</td><td style="text-align:right">${monF(pagado)}</td><td style="text-align:right;font-weight:700;color:${color}">${estado}</td></tr>`;
  }
  const debtHtml=(facNot||pagNot||facInf||facReg||provReg)?`
    <div style="margin-top:16px"><div style="font-size:12px;font-weight:700;color:var(--red);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px;padding-bottom:4px;border-bottom:2px solid var(--red-l)">üí∞ Resumen de deudas / pagos a terceros</div>
    <div class="card table-card"><table>
      <thead><tr><th>Concepto</th><th style="text-align:right">Factura</th><th style="text-align:right">Pagado</th><th style="text-align:right">Estado</th></tr></thead>
      <tbody>
        ${debtRow('Notar√≠a',facNot,pagNot,deudaNot)}
        ${debtRow('Informe t√©cnico',facInf,pagInf,deudaInf)}
        ${facReg||provReg?debtRow('Registro (Fra. vs Provisi√≥n)',facReg,provReg,deudaReg):''}
      </tbody>
      ${totalDeuda>0.01?`<tfoot><tr style="background:var(--red-l)"><td colspan="3" style="font-weight:700">TOTAL PENDIENTE</td><td style="text-align:right;font-weight:700;color:var(--red);font-size:15px">${monF(totalDeuda)}</td></tr></tfoot>`:''}
    </table></div></div>`:'';

  det.innerHTML=`
    <div class="detail-wrap">
      <button class="btn btn-ghost btn-sm" onclick="closeCtrl()">‚Üê Volver</button>
      <div class="detail-top" style="margin-top:10px">
        <div>
          <div class="detail-id">${esc(e.numExp)} ‚Äî ${esc(e.gestion)}</div>
          <div class="detail-sub">${esc(e.cliente)}${e.otros?' ¬∑ '+esc(e.otros):''}</div>
        </div>
        <div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap">
          ${estBadge(e.estado)}
          <button class="btn btn-green btn-sm" onclick="openDocs('${esc(e.numExp)}')">üìÇ Documentos</button>
          <button class="btn btn-amber btn-sm" onclick="goCliFromCtrl('${esc(e.numExp)}')">üí∂ Cliente ‚Ç¨</button>
          <button class="btn btn-ghost btn-sm" onclick="openChk('${esc(e.numExp)}')">üìã Checklist</button>
          <button class="btn btn-ghost btn-sm" onclick="openPlant('${esc(e.numExp)}')">üìÑ Notar√≠a</button>
          <button class="btn btn-primary btn-sm" onclick="openEditExp()">‚úèÔ∏è Editar</button>
          <button class="btn btn-ghost btn-sm" onclick="dupExp()">üìë Duplicar</button>
          <button class="btn btn-red btn-sm" onclick="deleteExp()">üóëÔ∏è</button>
        </div>
      </div>

      ${alertsHtml?'<div style="margin-top:12px">'+alertsHtml+'</div>':''}

      ${debtHtml}

      ${sec('üìã Datos del expediente',[
        ['N¬∫ Expediente',e.numExp],['Gesti√≥n',e.gestion],['Cliente',e.cliente],
        ['DNI',e.dni],['Otros intervinientes',e.otros]
      ])}

      ${sec('üèõÔ∏è Notar√≠a',[
        ['Notario/a',e.notario],
        ['Prevista firma',e.fhPrevista?fDH(e.fhPrevista):''],
        ['Fecha firma',fD(e.fechaFirma)],['Protocolo',e.protocolo],
        ['Factura notar√≠a',mon(e.impNotaria)],
        ['Pago 1',mon(e.pago1)+(e.fPago1?' ¬∑ '+fD(e.fPago1):'')],
        ['Pago 2',mon(e.pago2)+(e.fPago2?' ¬∑ '+fD(e.fPago2):'')],
        ['Retirada notar√≠a',fD(e.fRetirada)]
      ])}

      ${sec('üìÑ Informe t√©cnico',[
        ['Informe',e.informe],['Factura informe',mon(e.impInforme)],
        ['Fecha pago informe',fD(e.fPagoInforme)]
      ])}

      ${sec('üí∞ Plusval√≠a e impuestos',[
        ['Plusval√≠a',impBadge(e.plusvalia),1],
        e.plusvalia==='PRESENTADA'?['Fecha presentaci√≥n',fD(e.fPlusvalia)]:[],
        e.plusvalia==='SI'?['Vto. plusval√≠a (1 mes firma)',fD(e.vtoPlusvalia)]:[],
        ['Fecha fallecimiento',fD(e.fFallecimiento)],
        ['Mod. 600 (ITP/AJD)',impBadge(e.mod600),1],
        e.mod600==='PRESENTADO'?['Fecha pres. 600',fD(e.f600)]:[],
        e.mod600==='SI'?['Vto. Mod. 600 (2 meses firma)',fD(e.vto600)]:[],
        ['Mod. 650 (ISD)',impBadge(e.mod650),1],
        e.mod650==='PRESENTADO'?['Fecha pres. 650',fD(e.f650)]:[],
        e.mod650==='SI'?['Vto. Mod. 650 (6 meses fallec.)',fD(e.vto650)]:[],
        ['Mod. 660',impBadge(e.mod660),1],
        e.mod660==='PRESENTADO'?['Fecha pres. 660',fD(e.f660)]:[],
        e.mod660==='SI'?['Vto. Mod. 660 (6 meses fallec.)',fD(e.vto660)]:[]
      ].filter(f=>f.length))}

      ${sec('üìù Registro',[
        ['Registro',e.registro],['Entregado a registro',fD(e.fEntregaReg)],
        ['Provisi√≥n entregada',mon(e.provision)],['Lista para recoger',fD(e.fListaRecoger)],
        ['Factura registro',mon(e.totalFraReg)],['Fecha pago fra. registro',fD(e.fPagoFraReg)],
        ['Recogido de registro',fD(e.fRecogida)],['Entregado al cliente',fD(e.fEntregaCli)]
      ])}

      ${e.fVto?sec('‚è∞ Vencimiento manual',[['Fecha vto. actuaci√≥n',fD(e.fVto)]]):''}

      ${(e.inmuebles&&e.inmuebles.length)?'<div style="margin-top:16px"><div style="font-size:12px;font-weight:700;color:var(--accent);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px;padding-bottom:4px;border-bottom:2px solid var(--accent-l)">üè† Inmuebles</div>'+e.inmuebles.map(im=>'<div class="detail-grid" style="margin-bottom:8px">'+(im.tipo?'<div class="df"><label>Tipo</label><div class="val">'+esc(im.tipo)+'</div></div>':'')+(im.dir?'<div class="df"><label>Direcci√≥n</label><div class="val">'+esc(im.dir)+'</div></div>':'')+(im.mun?'<div class="df"><label>Municipio</label><div class="val">'+esc(im.mun)+'</div></div>':'')+(im.refCat?'<div class="df"><label>Ref. Catastral</label><div class="val">'+esc(im.refCat)+'</div></div>':'')+(im.finca?'<div class="df"><label>Finca Registral</label><div class="val">'+esc(im.finca)+'</div></div>':'')+(im.registro?'<div class="df"><label>Registro</label><div class="val">'+esc(im.registro)+'</div></div>':'')+(im.valor?'<div class="df"><label>Valor</label><div class="val">'+mon(im.valor)+'</div></div>':'')+'</div>').join('')+'</div>':''}

      <div class="obs-panel" style="margin-top:16px"><h4>üìå Observaciones / Historial</h4><div class="obs-content">${esc(e.obs||'Sin observaciones.')}</div>
        <div class="quick-add"><input id="qNote" placeholder="Escribe una novedad r√°pida..."><button class="btn btn-green btn-sm" onclick="addNote()">Ôºã</button></div>
      </div>
    </div>`;
}
function closeCtrl(){curExp=null;document.getElementById('ctrlList').style.display='block';document.getElementById('ctrlDet').style.display='none';}
function goCtrl(id){
  document.querySelectorAll('.tab-btn').forEach(x=>x.classList.remove('active'));
  document.querySelectorAll('.panel').forEach(x=>x.classList.remove('active'));
  document.querySelector('[data-tab="control"]').classList.add('active');
  document.getElementById('p-control').classList.add('active');
  showCtrl(id);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DETAIL CLIENTE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showCli(id){
  curCli=id;const c=clis.find(x=>x.numExp===id);if(!c)return;
  document.getElementById('cliList').style.display='none';
  const det=document.getElementById('cliDet');det.style.display='block';
  const e=exps.find(x=>x.numExp===id);
  const fraReg=e?mon(e.totalFraReg):'‚Äî';

  const items=[
    ['Fac. Informe T√©cnico',c.fraInfTec],['Asesoramiento',c.asesoramiento],
    ['Minuta Notar√≠a',c.minuta],['Fra. Notar√≠a',c.fraNotaria],
    ['Pres. Plusval√≠a',c.presPlusvalia],['Valor Declarar',c.valorDeclarar],['% ITP',c.pctITP],
    ['Liq. ITP',c.liqITP],['Mod. 600',c.mod600c],['Mod. 660',c.mod660c],
    ['Mod. 650 ('+esc(c.mod650qty||1)+'√ó'+mon(c.mod650unit)+')',c.mod650total],
    ['Pres. Liq. Impuesto',c.presLiqImp],['Pres. Rec. Registro',c.presRecReg],
    ['Prov. Registro',c.provReg],['Honorarios',c.honorarios],['IVA',c.iva],['Otros Servicios',c.otrosServ],
  ];
  const totalPagado=sumPagos(c);const pend=pf(c.totalExp)-totalPagado;
  const provDiff=pf(c.provReg)-pf(e?.totalFraReg||0);

  // Pagos rows
  const pagos=c.pagos||[];
  const pagosHtml=pagos.length?pagos.map((p,i)=>`
    <div class="pago-row">
      <span class="p-date">${fD(p.fecha)}</span>
      <span class="p-concept">${esc(p.concepto||'Pago '+(i+1))}</span>
      <span class="p-amount">${monF(p.importe)}</span>
      <button class="btn btn-ghost btn-sm" onclick="reciboFromPago(${i})" title="Generar recib√≠">üßæ</button>
    </div>`).join(''):'<div style="padding:12px;color:var(--dim);font-size:13px">Sin pagos registrados</div>';

  det.innerHTML=`
    <div class="detail-wrap">
      <button class="btn btn-ghost btn-sm" onclick="closeCli()">‚Üê Volver</button>
      <div class="detail-top" style="margin-top:10px">
        <div><div class="detail-id">${esc(c.numExp)} ‚Äî ${esc(c.cliente)}</div><div class="detail-sub">${esc(c.gestion)}</div></div>
        <div style="display:flex;gap:6px">
          <button class="btn btn-ghost btn-sm" onclick="goCtrlFromCli('${esc(c.numExp)}')">üìã Ver Control</button>
          <button class="btn btn-amber btn-sm" onclick="openEditCli()">‚úèÔ∏è Presupuesto</button>
          <button class="btn btn-primary btn-sm" onclick="downloadPresupuestoWord()">üìÑ Word</button>
        </div>
      </div>
      <h4 style="font-size:12px;color:var(--dim);text-transform:uppercase;margin:12px 0 6px">Desglose presupuesto</h4>
      <div class="detail-grid">
        ${items.filter(f=>pf(f[1])).map(f=>`<div class="df"><label>${f[0]}</label><div class="val">${mon(f[1])}</div></div>`).join('')}
        <div class="df"><label>Fra. Registro (de Control)</label><div class="val">${fraReg}</div></div>
        <div class="df" style="background:var(--accent-l);border-radius:6px;padding:8px"><label>TOTAL EXPEDIENTE</label><div class="val" style="font-size:18px;color:var(--accent)">${mon(c.totalExp)}</div></div>
        ${provDiff?`<div class="df"><label>Dif. Provisi√≥n vs Fra. Reg.</label><div class="val" style="color:${provDiff>=0?'var(--green)':'var(--red)'}">${monF(provDiff)}</div></div>`:''}
      </div>
      <h4 style="font-size:12px;color:var(--dim);text-transform:uppercase;margin:20px 0 6px">üí≥ Pagos del cliente</h4>
      <div class="card" style="overflow:hidden">${pagosHtml}
        <div class="pago-row" style="background:var(--bg);font-weight:700"><span class="p-date"></span><span class="p-concept">TOTAL PAGADO</span><span class="p-amount" style="color:var(--green)">${monF(totalPagado)}</span><span style="width:50px"></span></div>
        ${pend>0.01?`<div class="pago-row" style="background:var(--red-l)"><span class="p-date"></span><span class="p-concept" style="color:var(--red)">PENDIENTE</span><span class="p-amount" style="color:var(--red);font-size:15px">${monF(pend)}</span><span style="width:50px"></span></div>`:''}
      </div>
    </div>`;
}
function closeCli(){curCli=null;document.getElementById('cliList').style.display='block';document.getElementById('cliDet').style.display='none';}

function goCliFromCtrl(id){
  // Ensure CLI entry exists
  if(!clis.find(c=>c.numExp===id)){
    const e=exps.find(x=>x.numExp===id);
    if(e)clis.unshift({numExp:e.numExp,cliente:e.cliente,gestion:e.gestion,pagos:[],totalExp:'',finalizado:''});
    saveLocal();
  }
  closeCtrl();
  document.querySelectorAll('.tab-btn').forEach(x=>x.classList.remove('active'));
  document.querySelectorAll('.panel').forEach(x=>x.classList.remove('active'));
  document.querySelector('[data-tab="cliente"]').classList.add('active');
  document.getElementById('p-cliente').classList.add('active');
  renderCli();showCli(id);
}
function goCtrlFromCli(id){
  closeCli();
  document.querySelectorAll('.tab-btn').forEach(x=>x.classList.remove('active'));
  document.querySelectorAll('.panel').forEach(x=>x.classList.remove('active'));
  document.querySelector('[data-tab="control"]').classList.add('active');
  document.getElementById('p-control').classList.add('active');
  renderCtrl();showCtrl(id);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MODAL EXP ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const EF=['numExp','gestion','cliente','dni','otros','informe','impInforme','fPagoInforme',
  'notario','fhPrevista','fechaFirma','protocolo','impNotaria','pago1','fPago1','pago2','fPago2','fRetirada',
  'plusvalia','fPlusvalia','vtoPlusvalia',
  'fFallecimiento','mod600','f600','vto600','mod650','f650','vto650','mod660','f660','vto660',
  'registro','fEntregaReg','provision','fListaRecoger','totalFraReg','fPagoFraReg','fRecogida','fEntregaCli',
  'estado','fVto','obs'];
const COMBOS=['gestion','notario','registro'];

function openNewExp(){
  editMode='new';document.getElementById('mExpTit').textContent='‚ûï Nuevo Expediente';
  EF.forEach(f=>{const el=document.getElementById('e_'+f);if(el)el.value='';});
  COMBOS.forEach(c=>{setComboVal('combo_'+c,'');});
  document.getElementById('e_estado').value='pte_firma';
  ['fi_fPlusvalia','fi_vtoPlusvalia','fi_f600','fi_vto600','fi_f650','fi_vto650','fi_f660','fi_vto660'].forEach(id=>document.getElementById(id).style.display='none');
  document.getElementById('e_numExp').value=getNextExpNum();
  document.getElementById('inmueblesContainer').innerHTML='';
  document.getElementById('ovExp').classList.add('open');
}
function openEditExp(){
  editMode='edit';document.getElementById('mExpTit').textContent='‚úèÔ∏è Editar Expediente';
  const e=exps.find(x=>x.numExp===curExp);if(!e)return;
  EF.forEach(f=>{const el=document.getElementById('e_'+f);if(el)el.value=e[f]||'';});
  setComboVal('combo_gestion',e.gestion);
  setComboVal('combo_notario',e.notario);
  setComboVal('combo_registro',e.registro);
  togglePlusvalia();toggleImp('600');toggleImp('650');toggleImp('660');
  // Load inmuebles
  const cont=document.getElementById('inmueblesContainer');cont.innerHTML='';
  (e.inmuebles||[]).forEach(()=>addInmueble());
  (e.inmuebles||[]).forEach((im,i)=>{
    ['tipo','dir','mun','refCat','finca','registro','valor'].forEach(f=>{
      const el=document.getElementById('im_'+f+'_'+i);if(el)el.value=im[f]||'';
    });
  });
  document.getElementById('ovExp').classList.add('open');
}
function saveExp(){
  const d={};
  EF.forEach(f=>{const el=document.getElementById('e_'+f);d[f]=el?el.value.trim():'';});
  d.gestion=getComboVal('combo_gestion');d.notario=getComboVal('combo_notario');d.registro=getComboVal('combo_registro');
  d.inmuebles=collectInmuebles();
  // Preserve checklist
  if(editMode==='edit'){const old=exps.find(e=>e.numExp===curExp);if(old)d.checklist=old.checklist;}
  if(!d.numExp||!d.cliente){toast('Rellena N¬∫ Expediente y Cliente','err');return;}
  // Auto estado
  const ae=autoEstado(d);if(d.estado==='pte_firma'||!d.estado)d.estado=ae;
  if(editMode==='new'){
    if(exps.find(e=>e.numExp===d.numExp)){toast('Ya existe ese n¬∫','err');return;}
    exps.unshift(d);
    if(!clis.find(c=>c.numExp===d.numExp))clis.unshift({numExp:d.numExp,cliente:d.cliente,gestion:d.gestion,pagos:[],totalExp:'',finalizado:''});
    toast('‚úÖ Expediente '+d.numExp+' creado','ok');
  } else {
    const idx=exps.findIndex(e=>e.numExp===curExp);if(idx>=0)exps[idx]=d;
    const ci=clis.findIndex(c=>c.numExp===curExp);
    if(ci>=0){clis[ci].numExp=d.numExp;clis[ci].cliente=d.cliente;clis[ci].gestion=d.gestion;}
    curExp=d.numExp;toast('‚úÖ Actualizado','ok');
  }
  saveLocal();closeOv('ovExp');renderAll();
  if(editMode==='edit')showCtrl(curExp);
}
function deleteExp(){
  if(!curExp||!confirm('¬øEliminar '+curExp+'?'))return;
  exps=exps.filter(e=>e.numExp!==curExp);saveLocal();closeCtrl();renderAll();toast('Eliminado','info');
}
function addNote(){
  const note=document.getElementById('qNote').value.trim();if(!note||!curExp)return;
  const e=exps.find(x=>x.numExp===curExp);if(!e)return;
  const ts=new Date().toLocaleDateString('es-ES',{day:'2-digit',month:'2-digit',year:'2-digit'})+' '+new Date().toLocaleTimeString('es-ES',{hour:'2-digit',minute:'2-digit'});
  e.obs='['+ts+'] '+note+'\n'+(e.obs||'');
  saveLocal();showCtrl(curExp);renderAll();toast('Novedad a√±adida','ok');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MODAL CLIENTE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openEditCli(){
  const c=clis.find(x=>x.numExp===(curCli||curExp));if(!c)return;
  curCli=c.numExp;
  document.getElementById('mCliTit').textContent='üí∂ '+c.numExp;
  document.getElementById('c_numExp').value=c.numExp;
  document.getElementById('c_cliente').value=c.cliente;
  document.getElementById('c_gestion').value=c.gestion;
  const cFields=['fraInfTec','asesoramiento','minuta','fraNotaria','presPlusvalia','valorDeclarar','pctITP','liqITP','mod600c','mod660c','mod650unit','mod650qty','mod650total','presLiqImp','presRecReg','provReg','honorarios','iva','otrosServ','totalExp'];
  cFields.forEach(f=>{const el=document.getElementById('c_'+f);if(el)el.value=c[f]||'';});
  document.getElementById('c_finalizado').value=c.finalizado||'';
  // Fra registro from control
  const e=exps.find(x=>x.numExp===c.numExp);
  document.getElementById('c_fraReg').value=e?e.totalFraReg||'':'';
  calcDiffReg();
  // Build pagos
  renderPagosForm(c.pagos||[]);
  document.getElementById('ovCli').classList.add('open');
}
function renderPagosForm(pagos){
  const container=document.getElementById('pagosContainer');
  container.innerHTML='';
  pagos.forEach((p,i)=>{
    container.innerHTML+=`<div class="fi" style="grid-column:1/-1;display:flex;flex-direction:row;gap:8px;align-items:end;" id="pagoRow_${i}">
      <div style="flex:1"><label>Concepto</label><input id="pg_concepto_${i}" value="${esc(p.concepto||'')}"></div>
      <div style="width:120px"><label>Importe (‚Ç¨)</label><input type="number" step="0.01" id="pg_importe_${i}" value="${p.importe||''}"></div>
      <div style="width:130px"><label>Fecha</label><input type="date" id="pg_fecha_${i}" value="${p.fecha||''}"></div>
      <div style="width:90px"><label>N¬∫ Recibo</label><input id="pg_recibo_${i}" value="${esc(p.recibo||'')}"></div>
      <button class="btn btn-red btn-sm" style="margin-bottom:3px" onclick="removePagoRow(${i})">‚úï</button>
    </div>`;
  });
}
function addPagoRow(){
  const container=document.getElementById('pagosContainer');
  const i=container.children.length;
  const div=document.createElement('div');
  div.className='fi';div.style.cssText='grid-column:1/-1;display:flex;flex-direction:row;gap:8px;align-items:end;';
  div.id='pagoRow_'+i;
  div.innerHTML=`<div style="flex:1"><label>Concepto</label><input id="pg_concepto_${i}" placeholder="A cta. expediente"></div>
    <div style="width:120px"><label>Importe (‚Ç¨)</label><input type="number" step="0.01" id="pg_importe_${i}"></div>
    <div style="width:130px"><label>Fecha</label><input type="date" id="pg_fecha_${i}" value="${isoD(new Date())}"></div>
    <div style="width:90px"><label>N¬∫ Recibo</label><input id="pg_recibo_${i}"></div>
    <button class="btn btn-red btn-sm" style="margin-bottom:3px" onclick="this.parentElement.remove()">‚úï</button>`;
  container.appendChild(div);
}
function removePagoRow(i){document.getElementById('pagoRow_'+i)?.remove();}

function collectPagos(){
  const container=document.getElementById('pagosContainer');
  const pagos=[];
  container.querySelectorAll('[id^="pagoRow_"]').forEach(row=>{
    const idx=row.id.split('_')[1];
    const concepto=(document.getElementById('pg_concepto_'+idx)?.value||'').trim();
    const importe=document.getElementById('pg_importe_'+idx)?.value||'';
    const fecha=document.getElementById('pg_fecha_'+idx)?.value||'';
    const recibo=(document.getElementById('pg_recibo_'+idx)?.value||'').trim();
    if(importe||concepto)pagos.push({concepto,importe:pf(importe),fecha,recibo});
  });
  return pagos;
}

function calcITP(){
  const val=pf(document.getElementById('c_valorDeclarar').value);
  const pct=pf(document.getElementById('c_pctITP').value);
  document.getElementById('c_liqITP').value=val&&pct?(val*pct/100).toFixed(2):'';
  calcTotal();
}
function calcMod650(){
  const u=pf(document.getElementById('c_mod650unit').value);
  const q=pf(document.getElementById('c_mod650qty').value)||1;
  document.getElementById('c_mod650total').value=u?(u*q).toFixed(2):'';
  calcTotal();
}
function calcDiffReg(){
  const prov=pf(document.getElementById('c_provReg').value);
  const fra=pf(document.getElementById('c_fraReg').value);
  const diff=prov-fra;
  document.getElementById('c_diffReg').value=fra?diff.toFixed(2)+' ‚Ç¨'+(diff>=0?' (sobra)':' (falta)'):'';
}
function calcTotal(){
  const ids=['fraInfTec','asesoramiento','minuta','fraNotaria','presPlusvalia','liqITP','mod600c','mod660c','mod650total','presLiqImp','presRecReg','provReg','honorarios','iva','otrosServ'];
  let total=0;ids.forEach(id=>{total+=pf(document.getElementById('c_'+id)?.value);});
  document.getElementById('c_totalExp').value=total?total.toFixed(2):'';
  calcDiffReg();
}

function saveCli(){
  const c={numExp:document.getElementById('c_numExp').value,cliente:document.getElementById('c_cliente').value,gestion:document.getElementById('c_gestion').value};
  const cFields=['fraInfTec','asesoramiento','minuta','fraNotaria','presPlusvalia','valorDeclarar','pctITP','liqITP','mod600c','mod660c','mod650unit','mod650qty','mod650total','presLiqImp','presRecReg','provReg','honorarios','iva','otrosServ','totalExp'];
  cFields.forEach(f=>{c[f]=document.getElementById('c_'+f)?.value||'';});
  c.finalizado=document.getElementById('c_finalizado').value;
  c.pagos=collectPagos();
  const idx=clis.findIndex(x=>x.numExp===c.numExp);
  if(idx>=0)clis[idx]=c;else clis.push(c);
  saveLocal();closeOv('ovCli');renderCli();
  if(curCli)showCli(curCli);
  toast('‚úÖ Guardado','ok');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê RECIBO ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function reciboFromPago(i){
  const c=clis.find(x=>x.numExp===curCli);if(!c||!c.pagos[i])return;
  const p=c.pagos[i];
  // Global consecutive recibo number
  const nextNum=getNextReciboNum();
  document.getElementById('r_num').value=p.recibo||nextNum;
  document.getElementById('r_fecha').value=p.fecha||isoD(new Date());
  document.getElementById('r_cliente').value=c.cliente;
  document.getElementById('r_concepto').value=p.concepto||('A cta. expediente '+c.numExp+' ‚Äî '+c.gestion);
  document.getElementById('r_importe').value=p.importe||'';
  document.getElementById('reciboPreview').innerHTML='';
  document.getElementById('ovRecibo').classList.add('open');
}
function getNextReciboNum(){
  // Find the highest recibo number across ALL clients
  let max=parseInt(localStorage.getItem('lastRecibo')||'0');
  clis.forEach(c=>{(c.pagos||[]).forEach(p=>{
    const n=parseInt(p.recibo);if(n>max)max=n;
  });});
  return max+1;
}
function getNextExpNum(){
  const yr=new Date().getFullYear().toString().slice(-2);
  const nums=exps.map(e=>{const m=e.numExp.match(/\d+\/(\d+)/);return m?parseInt(m[1]):0;});
  return 'GE'+yr+'/'+(Math.max(0,...nums)+1);
}
function genRecibo(){
  const num=document.getElementById('r_num').value;
  const fecha=fD(document.getElementById('r_fecha').value);
  const cliente=document.getElementById('r_cliente').value;
  const concepto=document.getElementById('r_concepto').value;
  const importe=document.getElementById('r_importe').value;
  document.getElementById('reciboPreview').innerHTML=`
    <div class="recibo-box" id="recPrint">
      <div class="r-header"><strong>FRANCISCO JOSE JUSTO GUEVARA</strong><br>Av. Almanzora, n¬∫ 6, Local 2<br>04860 Olula del R√≠o (Almer√≠a)<br>Tlf. 950.44.16.15</div>
      <div class="r-num">RECIB√ç N¬∫ ${esc(num)} ‚Äî Fecha: ${fecha}</div><br>
      <strong>CLIENTE:</strong> ${esc(cliente)}<br><br>
      <strong>CONCEPTOS:</strong><br>${esc(concepto)}<br><br>
      <div class="r-total">HE RECIBIDO: ${monF(pf(importe))}</div>
      <br><br><div style="text-align:center;border-top:1px solid #ccc;padding-top:20px;color:#999;font-size:11px">Firma del cliente</div>
    </div>`;
  // Save globally
  localStorage.setItem('lastRecibo',num);
  toast('Recib√≠ N¬∫ '+num+' generado','ok');
}
function printRecibo(){
  const el=document.getElementById('recPrint');if(!el){toast('Genera primero el recib√≠','err');return;}
  const w=window.open('','','width=600,height=500');
  w.document.write('<html><head><title>Recib√≠</title><style>body{font-family:sans-serif;padding:30px}.recibo-box{border:2px solid #000;padding:24px;max-width:500px;margin:auto;font-size:13px;line-height:1.8}.r-header{text-align:center;border-bottom:1px solid #ccc;padding-bottom:10px;margin-bottom:10px}.r-header strong{font-size:15px}.r-num{text-align:right;font-weight:700}.r-total{font-size:18px;font-weight:700;text-align:right;border-top:2px solid #000;padding-top:8px;margin-top:8px}</style></head><body>');
  w.document.write(el.outerHTML);w.document.write('</body></html>');w.document.close();w.print();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê WORD EXPORT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function downloadPresupuestoWord(){
  const c=clis.find(x=>x.numExp===(curCli||curExp));if(!c){toast('No hay datos de cliente','err');return;}
  const e=exps.find(x=>x.numExp===c.numExp);
  const items=[];
  const add=(l,v)=>{if(pf(v))items.push([l,monF(pf(v))]);};
  add('Factura Informe T√©cnico',c.fraInfTec);add('Asesoramiento',c.asesoramiento);
  add('Minuta e Intervenci√≥n Notar√≠a',c.minuta);add('Factura Notar√≠a',c.fraNotaria);
  add('Presentaci√≥n Plusval√≠a',c.presPlusvalia);
  if(pf(c.liqITP))items.push(['Liquidaci√≥n ITP ('+monF(pf(c.valorDeclarar))+' x '+(c.pctITP||0)+'%)',monF(pf(c.liqITP))]);
  add('Mod. 600',c.mod600c);add('Mod. 660',c.mod660c);
  if(pf(c.mod650total))items.push(['Mod. 650 ('+(c.mod650qty||1)+' x '+monF(pf(c.mod650unit))+')',monF(pf(c.mod650total))]);
  add('Presentaci√≥n y Liquidaci√≥n Impuesto',c.presLiqImp);add('Presentaci√≥n y Recogida Registro',c.presRecReg);
  add('Provisi√≥n Registro',c.provReg);add('Honorarios',c.honorarios);add('IVA',c.iva);
  add('Otros Servicios',c.otrosServ);
  const fecha=new Date().toLocaleDateString('es-ES',{day:'2-digit',month:'long',year:'numeric'});
  let h='<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:w="urn:schemas-microsoft-com:office:word" xmlns="http://www.w3.org/TR/REC-html40"><head><meta charset="utf-8"><title>Presupuesto</title><style>@page{size:A4;margin:2.5cm}body{font-family:Arial,sans-serif;font-size:12pt;color:#222}h1{text-align:center;font-size:18pt;margin-bottom:20pt}.info{margin-bottom:6pt;font-size:11pt}.info b{display:inline-block;width:100pt}table{width:100%;border-collapse:collapse;margin-top:16pt}th{background:#d5e8f0;border:1px solid #bbb;padding:6pt 10pt;text-align:left;font-size:11pt}th.r{text-align:right}td{border:1px solid #ccc;padding:6pt 10pt;font-size:11pt}td.r{text-align:right}tr.tot td{font-weight:bold;font-size:12pt;border-top:2px solid #333}.note{margin-top:24pt;font-style:italic;color:#666;font-size:10pt}.firma{margin-top:20pt;text-align:right;font-size:11pt}</style></head><body>';
  h+='<h1>PRESUPUESTO</h1>';
  h+='<div class="info"><b>Cliente:</b> '+escX(c.cliente)+'</div>';
  if(e&&e.dni)h+='<div class="info"><b>DNI:</b> '+escX(e.dni)+'</div>';
  h+='<div class="info"><b>Expediente:</b> '+escX(c.numExp)+'</div>';
  h+='<div class="info"><b>Gesti√≥n:</b> '+escX(c.gestion)+'</div>';
  h+='<table><tr><th>CONCEPTO</th><th class="r">IMPORTE</th></tr>';
  items.forEach(function(it){h+='<tr><td>'+escX(it[0])+'</td><td class="r">'+escX(it[1])+'</td></tr>';});
  h+='<tr class="tot"><td>TOTAL EXPEDIENTE</td><td class="r">'+escX(monF(pf(c.totalExp)))+'</td></tr></table>';
  h+='<p class="note">Este presupuesto es orientativo y puede variar seg√∫n las circunstancias del expediente.</p>';
  h+='<p class="firma">Olula del R√≠o, '+escX(fecha)+'</p></body></html>';
  const blob=new Blob(['\ufeff'+h],{type:'application/msword'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');a.href=url;
  a.download='Presupuesto_'+c.numExp.replace(/\//g,'-')+'_'+c.cliente.replace(/ /g,'_')+'.doc';
  document.body.appendChild(a);a.click();document.body.removeChild(a);
  URL.revokeObjectURL(url);
  toast('Word descargado','ok');
}
function escX(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê AUTO ESTADO ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function autoEstado(d){
  if(d.fEntregaCli)return'entregado';
  if(d.fRecogida)return'recogido';
  if(d.fEntregaReg)return'en_registro';
  if(d.fRetirada&&(d.plusvalia==='SI'||d.mod600==='SI'||d.mod650==='SI'||d.mod660==='SI'))return'impuestos';
  if(d.fRetirada)return'retirado';
  if(d.fechaFirma)return'firmado';
  return'pte_firma';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê INMUEBLES ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function addInmueble(){
  const c=document.getElementById('inmueblesContainer');const i=c.children.length;
  const d=document.createElement('div');d.className='fg imm-row';d.id='imRow_'+i;
  d.innerHTML='<div class="fi"><label>Tipo</label><select id="im_tipo_'+i+'"><option>VIVIENDA</option><option>LOCAL</option><option>GARAJE</option><option>TERRENO</option><option>NAVE</option><option>OTRO</option></select></div><div class="fi"><label>Direcci√≥n</label><input id="im_dir_'+i+'"></div><div class="fi"><label>Municipio</label><input id="im_mun_'+i+'"></div><div class="fi"><label>Ref. Catastral</label><input id="im_refCat_'+i+'"></div><div class="fi"><label>Finca Registral</label><input id="im_finca_'+i+'"></div><div class="fi"><label>Registro</label><input id="im_registro_'+i+'"></div><div class="fi"><label>Valor (‚Ç¨)</label><input type="number" step="0.01" id="im_valor_'+i+'"></div><div class="fi"><button class="btn btn-red btn-sm" onclick="this.closest(\'.imm-row\').remove()" type="button">‚úï Quitar</button></div>';
  c.appendChild(d);
}
function collectInmuebles(){
  const c=document.getElementById('inmueblesContainer');const inms=[];
  c.querySelectorAll('.imm-row').forEach(row=>{
    const i=row.id.split('_')[1];const im={};
    ['tipo','dir','mun','refCat','finca','registro','valor'].forEach(f=>{im[f]=(document.getElementById('im_'+f+'_'+i)?.value||'').trim();});
    if(im.dir||im.refCat||im.finca)inms.push(im);
  });return inms;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DOCUMENTOS (CARPETA RED) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const DOCS_BASE='\\\\PACO-HP\\Users\\usuario\\Documents\\TRABAJOS';
const DOCS_MAP={
  'HERENCIA':'HERENCIAS','ADJUDICACION':'HERENCIAS','RENUNCIA':'HERENCIAS','LIQUIDACION HERENCIA':'HERENCIAS','REGULARIZACION':'HERENCIAS','ACEPT':'HERENCIAS',
  'DONACION':'DONACIONES',
  'DIVORCIO':'DIVORCIOS',
  'TESTAMENTO':'TESTAMENTOS',
  'PENAL':'PENAL','LABORAL':'LABORAL','MERCANTIL':'MERCANTIL','MONITORIOS':'MONITORIOS',
  'CLAUSULA SUELO':'CLAUSULA SUELO','DESAHUCIO':'DESAHUCIOS','CONTRATO':'CONTRATOS',
  'SEGURIDAD SOCIAL':'SEGURIDAD SOCIAL INCAPACIDADES','SEGUNDA OPORTUNIDAD':'SEGUNDA OPORTUNIDAD'
};
function getDocsSubcarpeta(gestion){
  const g=(gestion||'').toUpperCase();
  for(const[key,folder] of Object.entries(DOCS_MAP)){if(g.includes(key))return folder;}
  return'ESCRITURAS';
}
function getDocsFolder(e){
  const sub=getDocsSubcarpeta(e.gestion);
  const safe=(e.numExp+'-'+e.cliente+'-'+e.gestion).replace(/\//g,'-').replace(/[<>:"|?*]/g,'').replace(/\s+/g,' ').trim().substring(0,80);
  return DOCS_BASE+'\\'+sub+'\\'+safe;
}
function openDocs(id){
  const e=exps.find(x=>x.numExp===id);if(!e)return;
  const path=getDocsFolder(e);
  navigator.clipboard.writeText(path).then(()=>{
    toast('üìÇ Ruta copiada ‚Äî p√©gala en el Explorador de Windows (Ctrl+V)','ok');
  }).catch(()=>{
    prompt('Copia esta ruta y p√©gala en el Explorador:',path);
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DUPLICAR ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function dupExp(){
  const e=exps.find(x=>x.numExp===curExp);if(!e)return;
  const n=JSON.parse(JSON.stringify(e));
  n.numExp=getNextExpNum();n.obs='[Duplicado de '+e.numExp+']\n'+(n.obs||'');
  n.inmuebles=e.inmuebles?JSON.parse(JSON.stringify(e.inmuebles)):[];
  exps.unshift(n);clis.unshift({numExp:n.numExp,cliente:n.cliente,gestion:n.gestion,pagos:[],totalExp:'',finalizado:''});
  saveLocal();renderAll();showCtrl(n.numExp);toast('üìë Duplicado como '+n.numExp,'ok');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CHECKLIST ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openChk(id){
  const e=exps.find(x=>x.numExp===id);if(!e)return;
  document.getElementById('mChkTit').textContent='üìã Checklist ‚Äî '+e.numExp;
  const tipo=(e.gestion||'').toUpperCase();
  let tmpl=CHECKLISTS['DEFAULT'];
  Object.keys(CHECKLISTS).forEach(k=>{if(tipo.includes(k))tmpl=CHECKLISTS[k];});
  const saved=e.checklist||{};
  const body=document.getElementById('chkBody');
  body.innerHTML=tmpl.map((item,i)=>{
    const done=saved[item]?'checked':'';const cls=saved[item]?'chk-row done':'chk-row';
    return'<div class="'+cls+'" id="chk_'+i+'"><input type="checkbox" '+done+' onchange="tgChk(this)" data-item="'+esc(item)+'"><span>'+esc(item)+'</span></div>';
  }).join('')+'<div style="margin-top:12px;display:flex;gap:8px"><input id="chkCustom" placeholder="A√±adir documento..." style="flex:1;padding:8px 12px;border:1px solid var(--border);border-radius:6px;font-family:inherit"><button class="btn btn-ghost btn-sm" onclick="addChkItem()">Ôºã</button></div>';
  document.getElementById('ovChk').classList.add('open');
}
function tgChk(cb){cb.closest('.chk-row').classList.toggle('done',cb.checked);}
function addChkItem(){
  const inp=document.getElementById('chkCustom');const v=inp.value.trim();if(!v)return;
  const body=document.getElementById('chkBody');
  const d=document.createElement('div');d.className='chk-row';
  d.innerHTML='<input type="checkbox" data-item="'+esc(v)+'"><span>'+esc(v)+'</span>';
  body.insertBefore(d,body.lastElementChild);inp.value='';
}
function saveChk(){
  const e=exps.find(x=>x.numExp===curExp);if(!e)return;
  e.checklist={};
  document.getElementById('chkBody').querySelectorAll('.chk-row').forEach(row=>{
    const cb=row.querySelector('input[type=checkbox]');
    if(cb)e.checklist[cb.dataset.item]=cb.checked;
  });
  saveLocal();closeOv('ovChk');toast('‚úÖ Checklist guardado','ok');
  showCtrl(curExp);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PLANTILLA NOTAR√çA ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openPlant(id){
  const e=exps.find(x=>x.numExp===id);if(!e)return;
  let h='<strong>DATOS PARA ESCRITURA</strong><br><br>';
  h+='<strong>Tipo:</strong> '+esc(e.gestion)+'<br>';
  h+='<strong>Cliente:</strong> '+esc(e.cliente)+'<br>';
  if(e.dni)h+='<strong>DNI/NIE:</strong> '+esc(e.dni)+'<br>';
  if(e.otros)h+='<strong>Otros intervinientes:</strong> '+esc(e.otros)+'<br>';
  if(e.notario)h+='<strong>Notario/a:</strong> '+esc(e.notario)+'<br>';
  if(e.fhPrevista)h+='<strong>Fecha prevista:</strong> '+fDH(e.fhPrevista)+'<br>';
  if(e.inmuebles&&e.inmuebles.length){
    h+='<br><strong>INMUEBLES:</strong><br>';
    e.inmuebles.forEach((im,i)=>{
      h+='<br><em>Inmueble '+(i+1)+':</em><br>';
      if(im.tipo)h+='Tipo: '+esc(im.tipo)+'<br>';
      if(im.dir)h+='Direcci√≥n: '+esc(im.dir)+'<br>';
      if(im.mun)h+='Municipio: '+esc(im.mun)+'<br>';
      if(im.refCat)h+='Ref. Catastral: '+esc(im.refCat)+'<br>';
      if(im.finca)h+='Finca Registral: '+esc(im.finca)+'<br>';
      if(im.registro)h+='Registro: '+esc(im.registro)+'<br>';
      if(im.valor)h+='Valor: '+mon(im.valor)+'<br>';
    });
  }
  if(e.obs)h+='<br><strong>Observaciones:</strong><br>'+esc(e.obs);
  document.getElementById('plantBody').innerHTML=h;
  document.getElementById('ovPlant').classList.add('open');
}
function copyPlant(){
  const text=document.getElementById('plantBody').innerText;
  navigator.clipboard.writeText(text).then(()=>toast('üìã Copiado','ok')).catch(()=>toast('Error','err'));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CALENDARIO ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderCal(){
  const ms=['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
  document.getElementById('calTitle').textContent=ms[calMonth]+' '+calYear;
  const g=document.getElementById('calGrid');g.innerHTML='';
  ['Lun','Mar','Mi√©','Jue','Vie','S√°b','Dom'].forEach(d=>g.innerHTML+='<div class="cal-head">'+d+'</div>');
  const first=new Date(calYear,calMonth,1);const last=new Date(calYear,calMonth+1,0);
  let startDay=(first.getDay()+6)%7;
  const today=new Date();today.setHours(0,0,0,0);
  const events={};
  exps.forEach(e=>{
    if(e.fhPrevista){const d=new Date(e.fhPrevista);const k=d.getFullYear()+'-'+(d.getMonth()+1)+'-'+d.getDate();if(!events[k])events[k]=[];events[k].push({type:'firma',text:'‚úçÔ∏è '+e.numExp+' '+e.cliente});}
    if(e.fechaFirma){const d=new Date(e.fechaFirma);const k=d.getFullYear()+'-'+(d.getMonth()+1)+'-'+d.getDate();if(!events[k])events[k]=[];events[k].push({type:'firma',text:'‚úÖ '+e.numExp});}
    getAlerts(e).forEach(a=>{const k=a.fecha.getFullYear()+'-'+(a.fecha.getMonth()+1)+'-'+a.fecha.getDate();if(!events[k])events[k]=[];events[k].push({type:a.tipo==='exp'?'vto':'vto-ok',text:'‚è∞ '+e.numExp+' '+a.label});});
  });
  for(let i=0;i<startDay;i++){const d=new Date(calYear,calMonth,-startDay+i+1);g.innerHTML+='<div class="cal-day other"><div class="cal-num">'+d.getDate()+'</div></div>';}
  for(let d=1;d<=last.getDate();d++){
    const dt=new Date(calYear,calMonth,d);const isToday=dt.getTime()===today.getTime();
    const k=calYear+'-'+(calMonth+1)+'-'+d;const evs=events[k]||[];
    let html='<div class="cal-day'+(isToday?' today':'')+'"'+(evs.length?' onclick="calDayClick('+calYear+','+(calMonth+1)+','+d+')"':'')+'><div class="cal-num">'+d+'</div>';
    evs.slice(0,3).forEach(ev=>html+='<div class="cal-ev '+ev.type+'">'+esc(ev.text)+'</div>');
    if(evs.length>3)html+='<div class="cal-ev" style="color:var(--dim)">+'+(evs.length-3)+' m√°s</div>';
    html+='</div>';g.innerHTML+=html;
  }
  const totalCells=startDay+last.getDate();const rem=7-(totalCells%7);
  if(rem<7)for(let i=1;i<=rem;i++)g.innerHTML+='<div class="cal-day other"><div class="cal-num">'+i+'</div></div>';
}
function calMove(dir){calMonth+=dir;if(calMonth>11){calMonth=0;calYear++;}if(calMonth<0){calMonth=11;calYear--;}renderCal();}
function calToday(){calMonth=new Date().getMonth();calYear=new Date().getFullYear();renderCal();}
function calDayClick(y,m,d){/* could show day detail - for now just toast */toast('D√≠a '+d+'/'+m+'/'+y,'info');}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê FACTURACI√ìN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function buildFacMeses(){
  const sel=document.getElementById('fFacMes');const now=new Date();
  const ms=['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];
  for(let i=0;i<12;i++){const d=new Date(now.getFullYear(),now.getMonth()-i,1);sel.innerHTML+='<option value="'+d.getFullYear()+'-'+(d.getMonth()+1)+'">'+ms[d.getMonth()]+' '+d.getFullYear()+'</option>';}
}
function renderFac(){
  const sel=document.getElementById('fFacMes').value;const[y,m]=sel.split('-').map(Number);
  let cobrado=0,facturado=0,deudaCli=0,deudaTer=0;
  clis.forEach(c=>{
    (c.pagos||[]).forEach(p=>{if(p.fecha){const d=new Date(p.fecha);if(d.getMonth()+1===m&&d.getFullYear()===y)cobrado+=pf(p.importe);}});
    const pend=pf(c.totalExp)-sumPagos(c);if(pend>0.01)deudaCli+=pend;
    facturado+=pf(c.totalExp);
  });
  exps.forEach(e=>{
    const fN=pf(e.impNotaria),pN=pf(e.pago1)+pf(e.pago2);if(fN>pN)deudaTer+=(fN-pN);
    const fI=pf(e.impInforme);if(fI&&!e.fPagoInforme)deudaTer+=fI;
    const fR=pf(e.totalFraReg),pR=pf(e.provision);if(fR>pR)deudaTer+=(fR-pR);
  });
  document.getElementById('facStats').innerHTML='<div class="stat-box"><div class="label">Cobrado este mes</div><div class="num n-green">'+monF(cobrado)+'</div></div><div class="stat-box"><div class="label">Total facturado</div><div class="num n-blue">'+monF(facturado)+'</div></div><div class="stat-box"><div class="label">Te deben clientes</div><div class="num n-red">'+monF(deudaCli)+'</div></div><div class="stat-box"><div class="label">Debes a terceros</div><div class="num n-amber">'+monF(deudaTer)+'</div></div>';
  let dH='';
  exps.forEach(e=>{
    const fN=pf(e.impNotaria),pN=pf(e.pago1)+pf(e.pago2),dN=fN-pN;
    if(dN>0.01)dH+='<tr><td>'+esc(e.numExp)+'</td><td>'+esc(e.cliente)+'</td><td>Notar√≠a</td><td>'+monF(fN)+'</td><td>'+monF(pN)+'</td><td style="color:var(--red);font-weight:700">'+monF(dN)+'</td></tr>';
    const fI=pf(e.impInforme);if(fI&&!e.fPagoInforme)dH+='<tr><td>'+esc(e.numExp)+'</td><td>'+esc(e.cliente)+'</td><td>Informe</td><td>'+monF(fI)+'</td><td>0,00 ‚Ç¨</td><td style="color:var(--red);font-weight:700">'+monF(fI)+'</td></tr>';
    const fR=pf(e.totalFraReg),pR=pf(e.provision),ddR=fR-pR;
    if(ddR>0.01)dH+='<tr><td>'+esc(e.numExp)+'</td><td>'+esc(e.cliente)+'</td><td>Registro</td><td>'+monF(fR)+'</td><td>'+monF(pR)+'</td><td style="color:var(--red);font-weight:700">'+monF(ddR)+'</td></tr>';
  });
  document.getElementById('tDeudas').innerHTML=dH||'<tr><td colspan="6" style="text-align:center;color:var(--dim)">Sin deudas</td></tr>';
  let cH='';
  clis.forEach(c=>{const tp=sumPagos(c);const pe=pf(c.totalExp)-tp;if(pe>0.01)cH+='<tr class="rw" onclick="goTab(\'cliente\');showCli(\''+esc(c.numExp)+'\')"><td>'+esc(c.numExp)+'</td><td>'+esc(c.cliente)+'</td><td>'+mon(c.totalExp)+'</td><td>'+monF(tp)+'</td><td style="color:var(--red);font-weight:700">'+monF(pe)+'</td></tr>';});
  document.getElementById('tCliDeudas').innerHTML=cH||'<tr><td colspan="5" style="text-align:center;color:var(--dim)">Sin deudas</td></tr>';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CONTACTOS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openNewContact(){editContIdx=null;document.getElementById('mContTit').textContent='Nuevo Contacto';['ct_nombre','ct_tel','ct_email','ct_dir','ct_notas'].forEach(id=>document.getElementById(id).value='');document.getElementById('ct_tipo').value='Notario';document.getElementById('ovCont').classList.add('open');}
function openEditContact(i){editContIdx=i;const c=contacts[i];document.getElementById('mContTit').textContent='Editar Contacto';document.getElementById('ct_nombre').value=c.nombre;document.getElementById('ct_tipo').value=c.tipo;document.getElementById('ct_tel').value=c.tel||'';document.getElementById('ct_email').value=c.email||'';document.getElementById('ct_dir').value=c.dir||'';document.getElementById('ct_notas').value=c.notas||'';document.getElementById('ovCont').classList.add('open');}
function saveCont(){
  const c={nombre:document.getElementById('ct_nombre').value.trim(),tipo:document.getElementById('ct_tipo').value,tel:document.getElementById('ct_tel').value.trim(),email:document.getElementById('ct_email').value.trim(),dir:document.getElementById('ct_dir').value.trim(),notas:document.getElementById('ct_notas').value.trim()};
  if(!c.nombre){toast('Escribe un nombre','err');return;}
  if(editContIdx!==null)contacts[editContIdx]=c;else contacts.push(c);
  localStorage.setItem('contacts',JSON.stringify(contacts));
  closeOv('ovCont');renderContacts();toast('‚úÖ Contacto guardado','ok');
}
function deleteCont(i){if(!confirm('¬øEliminar contacto?'))return;contacts.splice(i,1);localStorage.setItem('contacts',JSON.stringify(contacts));renderContacts();toast('Eliminado','info');}
function renderContacts(){
  const s=(document.getElementById('sCont')?.value||'').toLowerCase();
  const ft=document.getElementById('fContTipo')?.value||'';
  const f=contacts.filter(c=>(!s||c.nombre.toLowerCase().includes(s)||((c.tel||'')+(c.email||'')).toLowerCase().includes(s))&&(!ft||c.tipo===ft));
  const cont=document.getElementById('contList');
  if(!f.length){cont.innerHTML='<div class="empty-msg" style="padding:40px;text-align:center;color:var(--dim)">Sin contactos. Crea uno con Ôºã</div>';return;}
  cont.innerHTML=f.map((c,i)=>{
    const ri=contacts.indexOf(c);
    return'<div class="contact-card"><div><span class="cn">'+esc(c.nombre)+'</span> <span class="badge b-blue">'+esc(c.tipo)+'</span>'+(c.tel?'<div class="cd">üìû '+esc(c.tel)+'</div>':'')+(c.email?'<div class="cd">‚úâÔ∏è '+esc(c.email)+'</div>':'')+(c.dir?'<div class="cd">üìç '+esc(c.dir)+'</div>':'')+(c.notas?'<div class="ct">'+esc(c.notas)+'</div>':'')+'</div><div style="display:flex;gap:4px"><button class="btn btn-ghost btn-sm" onclick="openEditContact('+ri+')">‚úèÔ∏è</button><button class="btn btn-red btn-sm" onclick="deleteCont('+ri+')">üóëÔ∏è</button></div></div>';
  }).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê EXPORT CSV ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function exportCSV(tipo){
  let csv='',filename='';
  if(tipo==='control'){
    csv='N¬∫ Exp;Gesti√≥n;Cliente;DNI;Notario;Fecha Firma;Protocolo;Fac.Notar√≠a;Pago1;Pago2;Plusval√≠a;Mod600;Mod650;Mod660;Registro;Provisi√≥n;Fra.Registro;Estado\n';
    exps.forEach(e=>csv+='"'+[e.numExp,e.gestion,e.cliente,e.dni,e.notario,fD(e.fechaFirma),e.protocolo,e.impNotaria||'',e.pago1||'',e.pago2||'',e.plusvalia||'',e.mod600||'',e.mod650||'',e.mod660||'',e.registro,e.provision||'',e.totalFraReg||'',e.estado].join('";"')+'"\n');
    filename='Control_Expedientes.csv';
  }else if(tipo==='cliente'){
    csv='N¬∫ Exp;Cliente;Gesti√≥n;Total;Pagado;Pendiente;Estado\n';
    clis.forEach(c=>{const tp=sumPagos(c);csv+='"'+[c.numExp,c.cliente,c.gestion,c.totalExp||'',tp.toFixed(2),(pf(c.totalExp)-tp).toFixed(2),c.finalizado||'En curso'].join('";"')+'"\n';});
    filename='Clientes_Facturacion.csv';
  }else{
    csv='N¬∫ Exp;Cliente;Concepto;Factura;Pagado;Pendiente\n';
    exps.forEach(e=>{
      const fN=pf(e.impNotaria),pN=pf(e.pago1)+pf(e.pago2),dN=fN-pN;
      if(dN>0.01)csv+='"'+[e.numExp,e.cliente,'Notar√≠a',fN.toFixed(2),pN.toFixed(2),dN.toFixed(2)].join('";"')+'"\n';
    });
    filename='Facturacion.csv';
  }
  const blob=new Blob(['\ufeff'+csv],{type:'text/csv;charset=utf-8'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=filename;document.body.appendChild(a);a.click();document.body.removeChild(a);
  toast('üì• Descargado','ok');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê GOOGLE SHEETS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function doConnect(){const u=document.getElementById('sheetUrl').value.trim();if(!u||!u.includes('script.google.com')){toast('URL no v√°lida','err');return;}SURL=u;localStorage.setItem('surl',u);updateConn();toast('Guardada. Probando...','info');doTest();}
async function doTest(){
  if(!SURL){toast('Pega la URL','err');return;}
  try{
    toast('Conectando...','info');
    const r=await fetch(SURL);const d=await r.json();
    if(d.status==='ok'){toast('‚úÖ Conexi√≥n OK. Cargando datos...','ok');await loadFromSheet();}
    else toast('Respuesta inesperada','err');
  }catch(e){toast('Error conexi√≥n: '+e.message,'err');}
}
async function loadFromSheet(){
  if(!SURL)return;
  try{
    const r=await fetch(SURL);const d=await r.json();
    if(d.status==='ok'){
      if(d.exps&&d.exps.length){
        // Reconstruct inmuebles and checklist from JSON if stored
        d.exps.forEach(e=>{
          if(typeof e.inmuebles_json==='string'&&e.inmuebles_json){try{e.inmuebles=JSON.parse(e.inmuebles_json);}catch(x){}}
          if(typeof e.checklist_json==='string'&&e.checklist_json){try{e.checklist=JSON.parse(e.checklist_json);}catch(x){}}
          delete e.inmuebles_json;delete e.checklist_json;
        });
        exps=d.exps;localStorage.setItem('exps',JSON.stringify(exps));
      }
      if(d.clis&&d.clis.length){
        d.clis.forEach(c=>{
          if(typeof c.pagos_json==='string'&&c.pagos_json){try{c.pagos=JSON.parse(c.pagos_json);}catch(x){c.pagos=[];}}
          delete c.pagos_json;
        });
        clis=d.clis;localStorage.setItem('clis',JSON.stringify(clis));
      }
      renderAll();toast('üì• Datos cargados de Sheets','ok');
    }
  }catch(e){console.log('Load error:',e);}
}
async function syncToSheet(){
  if(!SURL)return;
  try{
    // Prepare exps with JSON fields for complex data
    const expsToSend=exps.map(e=>{
      const copy=Object.assign({},e);
      copy.inmuebles_json=JSON.stringify(e.inmuebles||[]);
      copy.checklist_json=JSON.stringify(e.checklist||{});
      delete copy.inmuebles;delete copy.checklist;
      return copy;
    });
    const clisToSend=clis.map(c=>{
      const copy=Object.assign({},c);
      copy.pagos_json=JSON.stringify(c.pagos||[]);
      delete copy.pagos;
      return copy;
    });
    await fetch(SURL,{method:'POST',headers:{'Content-Type':'text/plain'},body:JSON.stringify({exps:expsToSend,clis:clisToSend})});
  }catch(e){console.log('Sync error:',e);}
}
function updateConn(){const b=document.getElementById('connBadge');if(SURL){b.className='conn-badge conn-ok';b.innerHTML='<div class="conn-dot"></div><span>Google Sheets ‚úì</span>';}else{b.className='conn-badge conn-no';b.innerHTML='<div class="conn-dot"></div><span>Sin conectar</span>';}}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê HELPERS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function saveLocal(){localStorage.setItem('exps',JSON.stringify(exps));localStorage.setItem('clis',JSON.stringify(clis));localStorage.setItem('contacts',JSON.stringify(contacts));syncToSheet();}
function closeOv(id){document.getElementById(id).classList.remove('open');}
function esc(s){if(!s)return'';const d=document.createElement('div');d.textContent=s;return d.innerHTML;}
function isoD(d){return d.toISOString().split('T')[0];}
function pf(v){return parseFloat(String(v||'0').replace(',','.'))||0;}
function sumPagos(c){return(c.pagos||[]).reduce((s,p)=>s+pf(p.importe),0);}

function fD(d){
  if(!d||d==='‚Äî')return'‚Äî';
  try{const p=String(d).split('T')[0].split('-');if(p.length===3)return p[2]+'/'+p[1]+'/'+p[0].slice(-2);
  }catch(e){}return d;
}
function fDH(d){
  if(!d)return'‚Äî';
  try{const dt=new Date(d);return dt.toLocaleDateString('es-ES',{day:'2-digit',month:'2-digit',year:'2-digit'})+' '+dt.toLocaleTimeString('es-ES',{hour:'2-digit',minute:'2-digit'});
  }catch(e){}return d;
}
function mon(v){const n=pf(v);if(!n)return'‚Äî';return n.toLocaleString('es-ES',{minimumFractionDigits:2,maximumFractionDigits:2})+' ‚Ç¨';}
function monF(n){return(typeof n==='number'?n:pf(n)).toLocaleString('es-ES',{minimumFractionDigits:2,maximumFractionDigits:2})+' ‚Ç¨';}
function estBadge(e){
  const m={pte_firma:['Pte. Firma','b-amber'],firmado:['Firmado','b-blue'],retirado:['Retirado Not.','b-teal'],impuestos:['Impuestos','b-amber'],en_registro:['En Registro','b-purple'],recogido:['Recogido','b-blue'],entregado:['Entregado','b-green'],finalizado:['Finalizado','b-green']};
  const[t,c]=m[e]||[e||'‚Äî','b-gray'];return`<span class="badge ${c}">${t}</span>`;
}
function impBadge(v){
  if(v==='EX')return'<span class="badge b-teal">Exento</span>';
  if(v==='SI')return'<span class="badge b-red">Pendiente</span>';
  if(v==='PRESENTADA'||v==='PRESENTADO')return'<span class="badge b-green">Presentado</span>';
  return'‚Äî';
}
function imp600Badge(e){
  const parts=[];
  if(e.mod600&&e.mod600!=='‚Äî')parts.push('600:'+impBadge(e.mod600));
  if(e.mod650&&e.mod650!=='‚Äî')parts.push('650:'+impBadge(e.mod650));
  if(e.mod660&&e.mod660!=='‚Äî')parts.push('660:'+impBadge(e.mod660));
  return parts.join(' ')||'‚Äî';
}
function toast(m,t){const e=document.getElementById('toast');e.textContent=m;e.className='toast t-'+(t||'info')+' show';setTimeout(()=>e.classList.remove('show'),3500);}
function copyScript(){navigator.clipboard.writeText(document.getElementById('scriptCode')?.textContent?.replace(/&lt;/g,'<').replace(/&gt;/g,'>')||'').then(()=>toast('Copiado','ok'));}
</script>
</body>
</html>
